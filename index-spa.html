<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suivi Conducteurs - Application Mobile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ============================================ */
    /* üé® FIGMA 2025 DESIGN SYSTEM MOBILE-FIRST */
    /* ============================================ */
    
    :root {
      /* üé® PALETTE MOBILE OPTIMIS√âE */
      --bg-primary: #FAFAFA;
      --bg-secondary: #F5F5F5;
      --bg-tertiary: #FFFFFF;
      --bg-card: #FFFFFF;
      --bg-input: #FFFFFF;
      
      --text-primary: #1A1A1A;
      --text-secondary: #4A4A4A;
      --text-tertiary: #6B7280;
      --text-muted: #9CA3AF;
      --text-white: #FFFFFF;
      --text-placeholder: #9CA3AF;
      
      --accent-primary: #14B8A6;
      --accent-hover: #0F766E;
      --accent-light: rgba(20, 184, 166, 0.1);
      --accent-focus: rgba(20, 184, 166, 0.2);
      
      --primary-color: #14B8A6;
      --primary-light: #7DD3FC;
      --primary-dark: #0F766E;
      --primary-gradient: linear-gradient(135deg, #14B8A6 0%, #0F766E 100%);
      
      --secondary-color: #10B981;
      --success-color: #059669;
      --error-color: #DC2626;
      --warning-color: #D97706;
      --danger-color: #DC2626;
      --info-color: #2563EB;
      
      --border-primary: #E5E7EB;
      --border-secondary: #D1D5DB;
      --border-focus: #14B8A6;
      
      /* üé® Ombres modernes */
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-xl: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      
      /* üé® Glassmorphism */
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.18);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      --glass-backdrop: blur(4px);
      
      /* üìè Espacement mobile-optimis√© */
      --spacing-xs: 0.25rem;  /* 4px */
      --spacing-sm: 0.5rem;   /* 8px */
      --spacing-md: 1rem;     /* 16px */
      --spacing-lg: 1.5rem;   /* 24px */
      --spacing-xl: 2rem;     /* 32px */
      --spacing-xxl: 3rem;    /* 48px */
      --spacing-mobile: 1.25rem; /* 20px - sp√©cial mobile */
      
      /* üìê Rayons */
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      
      /* üé≠ Animations */
      --transition-fast: 0.15s ease;
      --transition-normal: 0.3s ease;
      --transition-slow: 0.5s ease;
    }
    
    /* ============================================ */
    /* üì± BASE MOBILE-FIRST */
    /* ============================================ */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: var(--spacing-md);
      overflow-x: hidden;
      font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
      font-optical-sizing: auto;
      line-height: 1.6;
      font-size: 16px; /* Mobile-first: 16px base */
      font-weight: 400;
    }
    
    /* ============================================ */
    /* üìù TYPOGRAPHIE MOBILE-FIRST */
    /* ============================================ */
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      line-height: 1.3;
      margin: 0;
      color: var(--text-primary);
    }
    
    h1 {
      font-size: 1.875rem; /* 30px */
      font-weight: 700;
      letter-spacing: -0.025em;
    }
    
    h2 {
      font-size: 1.5rem; /* 24px */
      font-weight: 600;
      letter-spacing: -0.025em;
    }
    
    h3 {
      font-size: 1.25rem; /* 20px */
      font-weight: 600;
    }
    
    h4 {
      font-size: 1.125rem; /* 18px */
      font-weight: 500;
    }
    
    p, span, div {
      font-family: 'Inter', sans-serif;
    }
    
    label {
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      font-size: 0.875rem; /* 14px */
      color: var(--text-primary);
      line-height: 1.5;
    }
    
    input, textarea, select, button {
      font-family: 'Inter', sans-serif;
    }
    
    /* ============================================ */
    /* üì± RESPONSIVE MOBILE-FIRST */
    /* ============================================ */
    
    /* Tablette - Mode interm√©diaire */
    @media (min-width: 768px) {
      body {
        padding: var(--spacing-xl);
        max-width: 800px; /* Tablette - plus large */
        margin: 0 auto;
      }
      
      .app-container {
        max-width: 100%;
      }
      
      .btn {
        max-width: 600px;
        margin: var(--spacing-md) auto;
      }
      
      .radio-group {
        gap: var(--spacing-md);
      }
      
      .step-title {
        font-size: 1.75rem;
      }
      
      .section-title {
        font-size: 2.25rem;
      }
    }
    
    /* Desktop - Mode large */
    @media (min-width: 1024px) {
      body {
        max-width: 1000px;
        padding: var(--spacing-xxl);
      }
      
      .btn {
        max-width: 500px;
      }
      
      .form-group {
        max-width: 600px;
        margin: 0 auto var(--spacing-lg) auto;
      }
    }
    
    /* ============================================ */
    /* üèóÔ∏è LAYOUT PRINCIPAL */
    /* ============================================ */
    
    .app-container {
      max-width: 100vw;
      margin: 0 auto;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      min-height: calc(100vh - var(--spacing-md));
    }
    
    /* ============================================ */
    /* üì± HEADER MOBILE - FIGMA 2025 */
    /* ============================================ */
    
    .app-header {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: var(--spacing-xl) var(--spacing-md);
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
      border-bottom: 1px solid var(--border-primary);
    }
    
    .app-title {
      font-size: 32px;
      font-weight: 600;
      margin: 0;
      color: var(--accent-primary);
      letter-spacing: -0.5px;
      margin-bottom: 8px;
    }
    
    .app-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      font-weight: 300;
    }
    
    /* ============================================ */
    /* üß≠ NAVIGATION MOBILE - FIGMA 2025 */
    /* ============================================ */
    
    .nav-bar {
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border-primary);
      padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      display: flex;
      justify-content: space-around;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: var(--text-tertiary);
      font-size: 10px;
      font-weight: 500;
      padding: 8px 12px;
      min-width: 64px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 8px;
      min-height: 44px;
      justify-content: center;
    }
    
    .nav-item:active {
      transform: scale(0.95);
    }
    
    .nav-item.active {
      color: var(--accent-primary);
      background: var(--accent-light);
    }
    
    .nav-item .icon {
      font-size: 20px;
      margin-bottom: 4px;
    }
    
    .nav-label {
      font-size: 10px;
      font-weight: 500;
    }
    
    /* ============================================ */
    /* üìÑ SECTIONS / PAGES */
    /* ============================================ */
    
    .section {
      display: none;
      padding: var(--spacing-md);
      padding-bottom: 80px; /* Espace pour nav bottom */
      min-height: calc(100vh - 120px);
    }
    
    .section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* ============================================ */
    /* üîò BOUTONS MOBILES - FIGMA 2025 */
    /* ============================================ */
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-lg) var(--spacing-xl);
      border: none;
      border-radius: var(--radius-lg);
      font-size: 1.125rem; /* 18px pour mobile */
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      text-decoration: none;
      cursor: pointer;
      transition: all var(--transition-normal);
      min-height: 56px; /* Plus grand pour mobile */
      width: 100%;
      margin-bottom: var(--spacing-md);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.025em;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: var(--accent-primary);
      color: white;
      box-shadow: var(--shadow);
      border: 1px solid var(--accent-primary);
    }
    
    .btn-primary:hover, .btn-primary:focus {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--accent-primary);
      border: 1px solid var(--border-primary);
      box-shadow: var(--shadow);
    }
    
    .btn-secondary:hover, .btn-secondary:focus {
      background: var(--bg-secondary);
      border-color: var(--border-secondary);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-success {
      background: var(--success-color);
      color: white;
      box-shadow: var(--shadow);
      border: 1px solid var(--success-color);
    }
    
    .btn-warning {
      background: var(--warning-color);
      color: white;
      box-shadow: var(--shadow);
      border: 1px solid var(--warning-color);
    }
    
    .btn-danger {
      background: var(--error-color);
      color: white;
      box-shadow: var(--shadow);
      border: 1px solid var(--error-color);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    /* ============================================ */
    /* üè† PAGE ACCUEIL */
    /* ============================================ */
    
    .welcome-section {
      text-align: center;
      margin-bottom: var(--spacing-xl);
    }
    
    .welcome-icon {
      font-size: 4rem;
      margin-bottom: var(--spacing-md);
    }
    
    .welcome-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }
    
    .welcome-description {
      color: var(--text-secondary);
      line-height: 1.5;
    }
    
    .quick-actions {
      margin-bottom: var(--spacing-xl);
    }
    
    .action-grid {
      display: grid;
      gap: var(--spacing-md);
    }
    
    .action-card {
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: var(--spacing-xl);
      text-align: center;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .action-card:hover, .action-card:focus {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--border-secondary);
    }
    
    .action-icon {
      font-size: 2.5rem;
      margin-bottom: var(--spacing-md);
    }
    
    .action-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
    }
    
    .action-description {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    /* ============================================ */
    /* üì± RESPONSIVE DESKTOP */
    /* ============================================ */
    
    @media (min-width: 768px) {
      body {
        padding: var(--spacing-lg);
      }
      
      .app-container {
        max-width: 768px;
        margin: 0 auto;
      }
      
      .nav-bar {
        position: relative;
        bottom: auto;
        left: auto;
        right: auto;
        border-top: none;
        border-bottom: 1px solid var(--bg-tertiary);
        order: -1;
      }
      
      .section {
        padding-bottom: var(--spacing-md);
      }
      
      .action-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (min-width: 1024px) {
      .app-container {
        max-width: 1024px;
      }
      
      .action-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    /* ============================================ */
    /* üéØ STATUS INDICATORS - FIGMA 2025 */
    /* ============================================ */
    
    .status-indicator {
      position: absolute;
      top: var(--spacing-md);
      right: var(--spacing-md);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      z-index: 50;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }
    
    .status-online {
      background: var(--success-color);
      color: white;
      box-shadow: var(--shadow);
    }
    
    .status-offline {
      background: var(--error-color);
      color: white;
      box-shadow: var(--shadow);
    }
    
    .status-indicator::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* ============================================ */
    /* üöõ PHASE 1 - CONTR√îLES STYLES */
    /* ============================================ */
    
    .progress-container {
      margin-bottom: var(--spacing-lg);
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: var(--spacing-sm);
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary-gradient);
      border-radius: 999px;
      transition: width var(--transition-normal);
    }
    
    .progress-text {
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .step-container {
      display: none;
      padding: var(--spacing-lg);
      background: var(--bg-tertiary);
      border-radius: 10px;
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--border-primary);
    }
    
    .step-container.active {
      display: block;
      animation: slideIn var(--transition-normal) ease;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .step-title {
      font-size: 1.5rem; /* 24px pour mobile */
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      color: var(--text-primary);
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      letter-spacing: -0.025em;
      line-height: 1.3;
    }
    
    .section-title {
      font-size: 1.875rem; /* 30px */
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      color: var(--text-primary);
      letter-spacing: -0.025em;
      line-height: 1.2;
      margin-bottom: var(--spacing-xl);
      text-align: center;
    }
    
    .info-card, .reminder-card {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      border: 1px solid var(--border-primary);
      box-shadow: var(--shadow);
    }
    
    .info-card h4, .reminder-card h4 {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
    }
    
    .detail-grid {
      display: grid;
      gap: var(--spacing-sm);
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm);
      background: var(--bg-tertiary);
      border-radius: 6px;
      border: 1px solid var(--border-primary);
    }
    
    .detail-item .label {
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .detail-item .value {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .form-group {
      margin-bottom: var(--spacing-lg);
    }
    
    .form-group label {
      display: block;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }
    
    .form-group label.required::after {
      content: ' *';
      color: var(--error-color);
    }
    
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="time"],
    .form-group input[type="date"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: var(--spacing-lg) var(--spacing-md);
      border: 2px solid var(--border-primary);
      border-radius: var(--radius-lg);
      font-size: 1rem; /* 16px pour √©viter le zoom mobile */
      font-family: 'Inter', sans-serif;
      font-weight: 400;
      line-height: 1.5;
      transition: all var(--transition-normal);
      background: var(--bg-input);
      color: var(--text-primary);
      min-height: 48px; /* Touch-friendly */
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px var(--accent-focus);
      background: var(--bg-tertiary);
    }
    
    /* Inputs readonly - style sp√©cial */
    .form-group input[readonly],
    .form-group textarea[readonly] {
      background: var(--bg-secondary) !important;
      color: var(--text-secondary) !important;
      border-color: var(--border-secondary) !important;
      cursor: default;
      opacity: 1; /* Forcer l'opacit√© */
    }
    
    /* Placeholder mobile-friendly */
    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: var(--text-placeholder);
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      font-weight: 400;
      opacity: 0.7;
    }
    
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .radio-group {
      display: grid;
      gap: var(--spacing-md); /* Plus d'espace entre options */
      width: 100%;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: var(--spacing-lg); /* Plus d'espace entre radio et texte */
      padding: var(--spacing-lg) var(--spacing-xl); /* Plus de padding horizontal */
      background: var(--bg-input);
      border: 2px solid var(--border-primary);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--transition-normal);
      min-height: 56px; /* Touch-friendly height */
      position: relative;
      font-family: 'Inter', sans-serif;
      width: 100%; /* Assurer largeur compl√®te */
    }
    
    .radio-option:hover {
      border-color: var(--accent-primary);
      background: var(--accent-light);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    .radio-option:active {
      transform: translateY(0);
    }
    
    .radio-option input[type="radio"] {
      display: none;
    }
    
    /* Nouveau design radio moderne et plus gros */
    .radio-custom {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-secondary);
      border-radius: 50%;
      position: relative;
      transition: all var(--transition-normal);
      flex-shrink: 0;
      background: var(--bg-input);
    }
    
    .radio-option input[type="radio"]:checked + .radio-custom {
      border-color: var(--accent-primary);
      background: var(--accent-primary);
      box-shadow: 0 0 0 3px var(--accent-focus);
    }
    
    .radio-option input[type="radio"]:checked + .radio-custom::after {
      content: '';
      width: 10px;
      height: 10px;
      background: var(--text-white);
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    /* Style pour les labels radio */
    .radio-text {
      font-family: 'Inter', sans-serif;
      font-size: 1rem; /* 16px pour mobile */
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.4;
    }
    
    .radio-option input[type="radio"]:checked ~ .radio-text {
      color: var(--accent-primary);
      font-weight: 600;
    }
    
    .radio-text {
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .photo-upload {
      border: 2px dashed var(--border-primary);
      border-radius: 8px;
      padding: var(--spacing-lg);
      text-align: center;
      transition: border-color var(--transition-fast);
      background: var(--bg-secondary);
    }
    
    .photo-upload:hover {
      border-color: var(--accent-primary);
    }
    
    .photo-upload input[type="file"] {
      display: none;
    }
    
    .photo-label {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--accent-primary);
      color: white;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      box-shadow: var(--shadow);
    }
    
    .photo-label:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    .photo-preview {
      margin-top: var(--spacing-md);
    }
    
    .photo-preview img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-primary);
    }
    
    .step-navigation {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }
    
    .step-navigation .btn {
      flex: 1;
    }
    
    .main-navigation {
      margin-top: var(--spacing-xl);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--border-primary);
    }
    
    /* ============================================ */
    /* üîß UTILITAIRES */
    /* ============================================ */
    
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }
    
    .mt-sm { margin-top: var(--spacing-sm); }
    .mt-md { margin-top: var(--spacing-md); }
    .mt-lg { margin-top: var(--spacing-lg); }
    
    .mb-sm { margin-bottom: var(--spacing-sm); }
    .mb-md { margin-bottom: var(--spacing-md); }
    .mb-lg { margin-bottom: var(--spacing-lg); }
    
    .hidden { display: none !important; }
    .visible { display: block !important; }
    
  </style>
</head>
<body>
  
  <!-- üèóÔ∏è CONTAINER PRINCIPAL -->
  <div class="app-container">
    
    <!-- üì± HEADER -->
    <header class="app-header">
      <h1 class="app-title">Suivi Conducteurs</h1>
      <p class="app-subtitle">Application Mobile de Tourn√©e</p>
    </header>
    
    <!-- üîÑ STATUS CONNECTION - Integr√© dans le header -->
    <div id="connectionStatus" class="status-indicator status-online">
      <span id="syncStatus">En ligne</span>
      <button class="btn-retry" id="retrySync" onclick="uploadAllPendingPhotos()" style="display: none; margin-left: 8px; padding: 4px 8px; font-size: 10px; background: var(--warning); color: white; border: none; border-radius: 4px;">
        üîÑ Retry
      </button>
    </div>
    
    <!-- üß≠ NAVIGATION MOBILE -->
    <nav class="nav-bar">
      <a href="#" class="nav-item active" onclick="showSection('home')" id="nav-home">
        <span class="icon">üè†</span>
        <span class="nav-label">Accueil</span>
      </a>
      <a href="#" class="nav-item" onclick="showSection('phase0')" id="nav-phase0">
        <span class="icon">üë§</span>
        <span class="nav-label">Connexion</span>
      </a>
      <a href="#" class="nav-item" onclick="showSection('phase1')" id="nav-phase1">
        <span class="icon">üöõ</span>
        <span class="nav-label">Contr√¥les</span>
      </a>
      <a href="#" class="nav-item" onclick="showSection('phase2')" id="nav-phase2">
        <span class="icon">üì¶</span>
        <span class="nav-label">Livraisons</span>
      </a>
      <a href="#" class="nav-item" onclick="showSection('phase3')" id="nav-phase3">
        <span class="icon">‚úÖ</span>
        <span class="nav-label">Fin</span>
      </a>
    </nav>
    
    <!-- ============================================ -->
    <!-- üè† SECTION ACCUEIL -->
    <!-- ============================================ -->
    <section id="home" class="section active">
      
      <div class="welcome-section">
        <div class="welcome-icon">üöõ</div>
        <h2 class="welcome-title">Bienvenue !</h2>
        <p class="welcome-description">
          G√©rez votre tourn√©e √©tape par √©tape avec l'application mobile de suivi des conducteurs.
        </p>
      </div>
      
      <div class="quick-actions">
        <h3 class="text-center mb-lg">Actions Rapides</h3>
        
        <div class="action-grid">
          
          <button class="action-card" onclick="startNewTour()">
            <div class="action-icon">üöÄ</div>
            <h4 class="action-title">Nouvelle Tourn√©e</h4>
            <p class="action-description">Commencer une nouvelle tourn√©e depuis le d√©but</p>
          </button>
          
          <button class="action-card" onclick="showSection('resumeSession')">
            <div class="action-icon">üîÑ</div>
            <h4 class="action-title">Reprendre Session</h4>
            <p class="action-description">Continuer une tourn√©e en cours</p>
          </button>
          
          <button class="action-card" onclick="showSection('sessionHistory')">
            <div class="action-icon">üìä</div>
            <h4 class="action-title">Historique</h4>
            <p class="action-description">Voir les tourn√©es pr√©c√©dentes</p>
          </button>
          
        </div>
      </div>
      
    </section>
    
    <!-- ============================================ -->
    <!-- üë§ SECTION PHASE 0 - CONNEXION -->
    <!-- ============================================ -->
    <section id="phase0" class="section">
      <h2 class="text-center mb-lg">üë§ Identification Conducteur</h2>
      
      <div style="background: white; padding: var(--spacing-lg); border-radius: var(--radius-lg); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        
        <div class="mb-lg">
          <label for="conducteurCode" style="display: block; font-weight: 500; margin-bottom: var(--spacing-sm); color: var(--text-primary);">
            Code Conducteur (4 chiffres)
          </label>
          <input 
            type="number" 
            id="conducteurCode" 
            placeholder="Ex: 1001" 
            min="1000" 
            max="9999"
            style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--bg-tertiary); border-radius: var(--radius-md); font-size: 1.125rem; text-align: center;"
          >
        </div>
        
        <button class="btn btn-primary" onclick="connectConducteur()">
          üîê Se Connecter
        </button>
        
        <!-- Zone r√©sultat connexion -->
        <div id="conducteurResult" class="hidden mt-lg">
          <!-- Sera rempli dynamiquement -->
        </div>
        
        <!-- √âtape 2: S√©lection v√©hicules -->
        <div id="vehicleSelection" class="hidden mt-lg" style="background: var(--bg-tertiary); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid var(--border-primary);">
          <h3 style="margin-bottom: var(--spacing-lg); color: var(--text-primary);">üöõ S√©lection des V√©hicules</h3>
          
          <div class="info-card" style="margin-bottom: var(--spacing-lg);">
            <h4>üìã Informations Tourn√©e</h4>
            <div class="form-group">
              <label for="dateTournee" class="required">Date de la tourn√©e</label>
              <input type="date" id="dateTournee" required style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary);">
            </div>
            
            <div class="form-group">
              <label for="heureTournee" class="required">Heure pr√©vue de d√©part</label>
              <input type="time" id="heureTournee" required style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary);">
            </div>
            
            <div class="form-group">
              <label>Type de tourn√©e</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="typeTournee" value="1er Tour" checked>
                  <span class="radio-custom"></span>
                  <span class="radio-text">1er Tour</span>
                </label>
                <label class="radio-option">
                  <input type="radio" name="typeTournee" value="2√®me Tour">
                  <span class="radio-custom"></span>
                  <span class="radio-text">2√®me Tour</span>
                </label>
              </div>
            </div>
            
            <div class="form-group">
              <label>Type de livraison</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="typeLivraison" value="Frais" checked>
                  <span class="radio-custom"></span>
                  <span class="radio-text">Frais</span>
                </label>
                <label class="radio-option">
                  <input type="radio" name="typeLivraison" value="Sec">
                  <span class="radio-custom"></span>
                  <span class="radio-text">Sec</span>
                </label>
                <label class="radio-option">
                  <input type="radio" name="typeLivraison" value="Gel">
                  <span class="radio-custom"></span>
                  <span class="radio-text">Gel</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="selectTracteur" class="required">Tracteur</label>
            <select id="selectTracteur" required style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary);">
              <option value="">S√©lectionner un tracteur...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="selectRemorque" class="required">Remorque / Porteur</label>
            <select id="selectRemorque" required style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary);">
              <option value="">S√©lectionner une remorque...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="commentairesVehicules">Observations v√©hicules</label>
            <textarea id="commentairesVehicules" rows="2" placeholder="Remarques sur l'√©tat des v√©hicules..." style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary); resize: vertical;"></textarea>
          </div>
          
          <button class="btn btn-primary" onclick="validateVehicleSelection()">
            ‚úÖ Valider et Continuer
          </button>
        </div>
        
      </div>
      
    </section>
    
    <!-- ============================================ -->
    <!-- üöõ SECTION PHASE 1 - CONTR√îLES -->
    <!-- ============================================ -->
    <section id="phase1" class="section">
      <h2 class="text-center mb-lg">üöõ Contr√¥les Prise de Service</h2>
      
      <!-- Progress Bar -->
      <div class="progress-container" style="margin-bottom: var(--spacing-lg);">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>
        <div class="progress-text">
          <span id="progressText">√âtape 1 sur 6</span>
        </div>
      </div>
      
      <!-- √âtape 1: R√©capitulatif -->
      <div class="step-container active" id="step1">
        <h3 class="step-title">üë§ R√©capitulatif Session</h3>
        
        <div class="info-card">
          <h4>üìã Informations de la Tourn√©e</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Conducteur :</span>
              <span class="value" id="recapConducteur">Chargement...</span>
            </div>
            <div class="detail-item">
              <span class="label">Site :</span>
              <span class="value" id="recapSite">Chargement...</span>
            </div>
            <div class="detail-item">
              <span class="label">Date :</span>
              <span class="value" id="recapDate">Chargement...</span>
            </div>
            <div class="detail-item">
              <span class="label">Heure :</span>
              <span class="value" id="recapHeure">Chargement...</span>
            </div>
            <div class="detail-item">
              <span class="label">Tour :</span>
              <span class="value" id="recapTour">Chargement...</span>
            </div>
            <div class="detail-item">
              <span class="label">Type :</span>
              <span class="value" id="recapType">Chargement...</span>
            </div>
            <div class="detail-item">
              <span class="label">Tracteur :</span>
              <span class="value" id="recapTracteur">Chargement...</span>
            </div>
            <div class="detail-item">
              <span class="label">Remorque :</span>
              <span class="value" id="recapRemorque">Chargement...</span>
            </div>
          </div>
        </div>
        
        <div class="reminder-card">
          <h4>üöõ Contr√¥les de Prise de Service</h4>
          <p>Vous allez maintenant effectuer les contr√¥les obligatoires avant le d√©part :</p>
          <ul>
            <li>√âtat du tracteur (d√©g√¢ts, kilom√©trage, carburant)</li>
            <li>√âtat de la remorque (d√©g√¢ts, hayon, √©clairage)</li>
            <li>V√©rification du chargement</li>
            <li>Photos de contr√¥le</li>
          </ul>
        </div>
        
        <div class="form-group">
          <label for="numeroContrat" class="required">Tour ou num√©ro de contrat</label>
          <input type="text" id="numeroContrat" placeholder="Ex: T001, Contrat 12345..." required>
        </div>
        
        <button class="btn btn-primary" onclick="nextPhase1Step()">
          Suivant - Tracteur ‚Üí
        </button>
      </div>
      
      <!-- √âtape 2: Tracteur -->
      <div class="step-container" id="step2">
        <h3 class="step-title">üöõ Tracteur</h3>
        
        <div class="form-group">
          <label for="immatTracteur">Immatriculation tracteur</label>
          <input type="text" id="immatTracteur" readonly required style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary);">
          <small style="color: var(--text-secondary); font-size: 11px;">üîí V√©hicule s√©lectionn√© en Phase 0</small>
        </div>
        
        <div class="form-group">
          <label>Nouveaux d√©g√¢ts constat√©s tracteur ?</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="degatsTracteur" value="Non" checked onclick="hideDegatsTracteurDetails()">
              <span class="radio-custom"></span>
              <span class="radio-text">Non</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="degatsTracteur" value="Oui" onclick="showDegatsTracteurDetails()">
              <span class="radio-custom"></span>
              <span class="radio-text">Oui</span>
            </label>
          </div>
        </div>
        
        <!-- D√©tails d√©g√¢ts tracteur (masqu√© par d√©faut) -->
        <div class="form-group" id="degatsTracteurDetails" style="display: none;">
          <label for="detailsDegatsTracteur">D√©tails des d√©g√¢ts tracteur</label>
          <textarea id="detailsDegatsTracteur" rows="3" placeholder="D√©crivez les d√©g√¢ts constat√©s..." style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px;"></textarea>
        </div>
        
        <div class="form-group">
          <label for="kilometrage" class="required">Kilom√©trage</label>
          <input type="number" id="kilometrage" required>
        </div>
        
        <div class="form-group">
          <label class="required">Photo niveau carburant</label>
          <div class="photo-upload">
            <input type="file" id="photoCarburant" accept="image/*" capture="environment">
            <label for="photoCarburant" class="photo-label">
              ‚õΩ Prendre photo carburant
            </label>
            <div class="photo-preview" id="previewCarburant"></div>
          </div>
        </div>
        
        <div class="step-navigation">
          <button class="btn btn-secondary" onclick="prevPhase1Step()">‚Üê Pr√©c√©dent</button>
          <button class="btn btn-primary" onclick="nextPhase1Step()">Suivant - Photos Tracteur ‚Üí</button>
        </div>
      </div>
      
      <!-- √âtape 3: Photos Tracteur -->
      <div class="step-container" id="step3">
        <h3 class="step-title">üì∏ Photos Tracteur</h3>
        
        <div class="form-group">
          <label>Photos face avant tracteur <small>(max 3)</small></label>
          <div class="photo-upload">
            <input type="file" id="photoFaceAvant" accept="image/*" capture="environment" multiple>
            <label for="photoFaceAvant" class="photo-label">
              üì∑ Ajouter photo(s) face avant
            </label>
            <div class="photo-preview" id="previewFaceAvant"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Photo c√¥t√© passager</label>
          <div class="photo-upload">
            <input type="file" id="photoCotePassager" accept="image/*" capture="environment">
            <label for="photoCotePassager" class="photo-label">
              üì∑ Photo c√¥t√© passager
            </label>
            <div class="photo-preview" id="previewCotePassager"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Photo c√¥t√© conducteur</label>
          <div class="photo-upload">
            <input type="file" id="photoCoteConducteur" accept="image/*" capture="environment">
            <label for="photoCoteConducteur" class="photo-label">
              üì∑ Photo c√¥t√© conducteur
            </label>
            <div class="photo-preview" id="previewCoteConducteur"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="commentairesTracteur">Commentaires tracteur</label>
          <textarea id="commentairesTracteur" rows="3" placeholder="Observations sur l'√©tat du tracteur..." style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary); resize: vertical;"></textarea>
        </div>
        
        <div class="step-navigation">
          <button class="btn btn-secondary" onclick="prevPhase1Step()">‚Üê Pr√©c√©dent</button>
          <button class="btn btn-primary" onclick="nextPhase1Step()">Suivant - Remorque ‚Üí</button>
        </div>
      </div>
      
      <!-- √âtape 4: Remorque -->
      <div class="step-container" id="step4">
        <h3 class="step-title">üöö Remorque et Hayon</h3>
        
        <div class="info-card">
          <h4>‚ö†Ô∏è Consigne Branchement ABS</h4>
          <p>Avant tout branchement, coupez syst√©matiquement le contact afin d'√©viter tout dysfonctionnement.</p>
        </div>
        
        <div class="form-group">
          <label for="immatRemorque">Immatriculation remorque</label>
          <input type="text" id="immatRemorque" readonly required style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary);">
          <small style="color: var(--text-secondary); font-size: 11px;">üîí V√©hicule s√©lectionn√© en Phase 0</small>
        </div>
        
        <div class="form-group">
          <label>Nouveaux d√©g√¢ts constat√©s remorque ?</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="degatsRemorque" value="Non" checked onclick="hideDegatsRemorqueDetails()">
              <span class="radio-custom"></span>
              <span class="radio-text">Non</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="degatsRemorque" value="Oui" onclick="showDegatsRemorqueDetails()">
              <span class="radio-custom"></span>
              <span class="radio-text">Oui</span>
            </label>
          </div>
        </div>
        
        <!-- D√©tails d√©g√¢ts remorque (masqu√© par d√©faut) -->
        <div class="form-group" id="degatsRemorqueDetails" style="display: none;">
          <label for="detailsDegatsRemorque">D√©tails des d√©g√¢ts remorque</label>
          <textarea id="detailsDegatsRemorque" rows="3" placeholder="D√©crivez les d√©g√¢ts constat√©s..." style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px;"></textarea>
        </div>
        
        <div class="form-group">
          <label>Photo jauge carburant remorque</label>
          <div class="photo-upload">
            <input type="file" id="photoCarburantRemorque" accept="image/*" capture="environment">
            <label for="photoCarburantRemorque" class="photo-label">
              ‚õΩ Photo jauge remorque
            </label>
            <div class="photo-preview" id="previewCarburantRemorque"></div>
          </div>
          <small style="color: var(--text-secondary); font-size: 11px;">Si porteur, passer √† la suite</small>
        </div>
        
        <div class="form-group">
          <label class="required">Test hayon (photo hayon d√©ploy√©)</label>
          <div class="photo-upload">
            <input type="file" id="photoHayon" accept="image/*" capture="environment">
            <label for="photoHayon" class="photo-label">
              üîß Photo hayon d√©ploy√©
            </label>
            <div class="photo-preview" id="previewHayon"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="commentairesRemorque">Commentaires remorque</label>
          <textarea id="commentairesRemorque" rows="3" placeholder="Pr√©cisions sur les d√©g√¢ts ou autres observations..." style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary); resize: vertical;"></textarea>
        </div>
        
        <div class="step-navigation">
          <button class="btn btn-secondary" onclick="prevPhase1Step()">‚Üê Pr√©c√©dent</button>
          <button class="btn btn-primary" onclick="nextPhase1Step()">Suivant - Chargement ‚Üí</button>
        </div>
      </div>
      
      <!-- √âtape 5: Chargement -->
      <div class="step-container" id="step5">
        <h3 class="step-title">üì¶ V√©rification Chargement</h3>
        
        <div class="form-group">
          <label>Photo du chargement</label>
          <div class="photo-upload">
            <input type="file" id="photoChargement" accept="image/*" capture="environment">
            <label for="photoChargement" class="photo-label">
              üì¶ Photo chargement
            </label>
            <div class="photo-preview" id="previewChargement"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Photo remorque portes ferm√©es</label>
          <div class="photo-upload">
            <input type="file" id="photoRemorquePortes" accept="image/*" capture="environment">
            <label for="photoRemorquePortes" class="photo-label">
              üö™ Photo portes ferm√©es
            </label>
            <div class="photo-preview" id="previewRemorquePortes"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Chargement conforme ?</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="chargementConforme" value="Oui" checked>
              <span class="radio-custom"></span>
              <span class="radio-text">Oui, conforme</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="chargementConforme" value="Non">
              <span class="radio-custom"></span>
              <span class="radio-text">Non, anomalie</span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="commentairesChargement">Commentaires chargement</label>
          <textarea id="commentairesChargement" rows="3" placeholder="Observations sur le chargement..." style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary); resize: vertical;"></textarea>
        </div>
        
        <div class="step-navigation">
          <button class="btn btn-secondary" onclick="prevPhase1Step()">‚Üê Pr√©c√©dent</button>
          <button class="btn btn-primary" onclick="nextPhase1Step()">Finaliser ‚Üí</button>
        </div>
      </div>
      
      <!-- √âtape 6: Finalisation -->
      <div class="step-container" id="step6">
        <h3 class="step-title">‚úÖ Finalisation Prise de Service</h3>
        
        <div class="info-card">
          <h4>üéâ Contr√¥les Termin√©s</h4>
          <p>Tous les contr√¥les de prise de service ont √©t√© effectu√©s. V√©rifiez le r√©capitulatif ci-dessous avant de continuer.</p>
        </div>
        
        <div class="reminder-card">
          <h4>üìã R√©capitulatif Final</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Photos prises :</span>
              <span class="value" id="finalPhotosCount">0</span>
            </div>
            <div class="detail-item">
              <span class="label">D√©g√¢ts signal√©s :</span>
              <span class="value" id="finalDegats">Aucun</span>
            </div>
            <div class="detail-item">
              <span class="label">Chargement :</span>
              <span class="value" id="finalChargement">Conforme</span>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="heureDepart" class="required">Heure de d√©part r√©elle</label>
          <input type="time" id="heureDepart" required style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary);">
        </div>
        
        <div class="form-group">
          <label for="commentairesFinaux">Commentaires finaux</label>
          <textarea id="commentairesFinaux" rows="3" placeholder="Observations g√©n√©rales sur la prise de service..." style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary); resize: vertical;"></textarea>
        </div>
        
        <div class="step-navigation">
          <button class="btn btn-secondary" onclick="prevPhase1Step()">‚Üê Pr√©c√©dent</button>
          <button class="btn btn-success" onclick="completePhase1()" style="font-size: 1.1rem; padding: var(--spacing-lg);">
            ‚úÖ Terminer Prise de Service
          </button>
        </div>
      </div>
      
      <!-- Navigation principale -->
      <div class="main-navigation">
        <button class="btn btn-secondary" onclick="showSection('phase0')">
          üë§ Retour Connexion
        </button>
        <button class="btn btn-success" onclick="showSection('phase2')" style="display: none;" id="btnPhase2">
          üì¶ Continuer vers Livraisons
        </button>
      </div>
      
    </section>
    
    <!-- ============================================ -->
    <!-- üì¶ SECTION PHASE 2 - LIVRAISONS -->
    <!-- ============================================ -->
    <section id="phase2" class="section">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title">üì¶ Suivi des Livraisons</h2>
          <div class="progress-indicator">
            <span id="livraisonProgress">0 / 0 magasins</span>
          </div>
        </div>
        
        <!-- Informations g√©n√©rales -->
        <div class="info-card">
          <h3>üìã Informations Tourn√©e</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Conducteur :</span>
              <span class="value" id="phase2Conducteur">-</span>
            </div>
            <div class="detail-item">
              <span class="label">V√©hicule :</span>
              <span class="value" id="phase2Vehicule">-</span>
            </div>
            <div class="detail-item">
              <span class="label">Heure d√©part :</span>
              <span class="value" id="phase2HeureDepart">-</span>
            </div>
          </div>
        </div>
        
        <!-- Formulaire ajout magasin -->
        <div class="form-card">
          <h3>üè™ Ajouter une Livraison</h3>
          
          <div class="form-group">
            <label for="nomMagasin" class="required">Nom du magasin</label>
            <input type="text" id="nomMagasin" placeholder="Ex: LIDL Chanteloup" required>
          </div>
          
          <div class="form-group">
            <label for="adresseMagasin">Adresse</label>
            <input type="text" id="adresseMagasin" placeholder="Adresse compl√®te">
          </div>
          
          <div class="form-group">
            <label for="heureLivraison" class="required">Heure de livraison</label>
            <input type="time" id="heureLivraison" required>
          </div>
          
          <div class="form-group">
            <label>Livraison effectu√©e ?</label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="livraisonEffectuee" value="Oui" checked>
                <span class="radio-custom"></span>
                <span class="radio-text">‚úÖ Oui, livr√©e</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="livraisonEffectuee" value="Non">
                <span class="radio-custom"></span>
                <span class="radio-text">‚ùå Non livr√©e</span>
              </label>
            </div>
          </div>
          
          <div class="form-group" id="motifNonLivraison" style="display: none;">
            <label for="motifRefus">Motif de non-livraison</label>
            <select id="motifRefus" style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary);">
              <option value="">S√©lectionner un motif...</option>
              <option value="Magasin ferm√©">Magasin ferm√©</option>
              <option value="Refus r√©ception">Refus de r√©ception</option>
              <option value="Probl√®me acc√®s">Probl√®me d'acc√®s</option>
              <option value="Autre">Autre motif</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Photo du magasin <small>(max 3)</small></label>
            <div class="photo-upload">
              <input type="file" id="photoMagasin" accept="image/*" capture="environment" multiple>
              <label for="photoMagasin" class="photo-label">
                üì∑ Ajouter photo(s) magasin
              </label>
              <div class="photo-preview" id="previewMagasin"></div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="commentaireLivraison">Commentaires</label>
            <textarea id="commentaireLivraison" rows="3" placeholder="Observations sur la livraison..." style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary); resize: vertical;"></textarea>
          </div>
          
          <button class="btn btn-primary" onclick="ajouterLivraison()">
            ‚ûï Ajouter cette Livraison
          </button>
        </div>
        
        <!-- Liste des livraisons -->
        <div class="livraisons-list" id="livraisonsList">
          <h3>üìã Livraisons Effectu√©es</h3>
          <div id="livraisonsContainer">
            <p class="empty-state" style="text-align: center; color: var(--text-secondary); padding: var(--spacing-xl);">Aucune livraison enregistr√©e</p>
          </div>
        </div>
        
        <!-- Navigation -->
        <div class="main-navigation">
          <button class="btn btn-secondary" onclick="showSection('phase1')">
            ‚Üê Retour Contr√¥les
          </button>
          <button class="btn btn-success" onclick="terminerLivraisons()" id="btnTerminerLivraisons" style="display: none;">
            ‚úÖ Terminer les Livraisons
          </button>
        </div>
      </div>
      
    </section>
    
    <!-- ============================================ -->
    <!-- ‚úÖ SECTION PHASE 3 - FIN SERVICE -->
    <!-- ============================================ -->
    <section id="phase3" class="section">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title">‚úÖ Fin de Service</h2>
          <div class="progress-indicator">
            <span id="finServiceProgress">Finalisation en cours...</span>
          </div>
        </div>
        
        <!-- R√©capitulatif complet -->
        <div class="info-card">
          <h3>üìä R√©capitulatif de la Tourn√©e</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Conducteur :</span>
              <span class="value" id="phase3Conducteur">-</span>
            </div>
            <div class="detail-item">
              <span class="label">Date :</span>
              <span class="value" id="phase3Date">-</span>
            </div>
            <div class="detail-item">
              <span class="label">Heure d√©part :</span>
              <span class="value" id="phase3HeureDepart">-</span>
            </div>
            <div class="detail-item">
              <span class="label">V√©hicules :</span>
              <span class="value" id="phase3Vehicules">-</span>
            </div>
            <div class="detail-item">
              <span class="label">Livraisons :</span>
              <span class="value" id="phase3Livraisons">-</span>
            </div>
            <div class="detail-item">
              <span class="label">Photos prises :</span>
              <span class="value" id="phase3Photos">-</span>
            </div>
          </div>
        </div>
        
        <!-- Contr√¥les fin de service -->
        <div class="form-card">
          <h3>üîç Contr√¥les Fin de Service</h3>
          
          <div class="form-group">
            <label for="heureRetour" class="required">Heure de retour r√©elle</label>
            <input type="time" id="heureRetour" required style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary);">
          </div>
          
          <div class="form-group">
            <label for="kilometrageFinal" class="required">Kilom√©trage final</label>
            <input type="number" id="kilometrageFinal" placeholder="Ex: 246150" required style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary);">
          </div>
          
          <div class="form-group">
            <label>√âtat g√©n√©ral du v√©hicule</label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="etatVehicule" value="Bon" checked>
                <span class="radio-custom"></span>
                <span class="radio-text">‚úÖ Bon √©tat</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="etatVehicule" value="D√©g√¢ts">
                <span class="radio-custom"></span>
                <span class="radio-text">‚ö†Ô∏è Nouveaux d√©g√¢ts</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="etatVehicule" value="Probl√®me">
                <span class="radio-custom"></span>
                <span class="radio-text">‚ùå Probl√®me technique</span>
              </label>
            </div>
          </div>
          
          <div class="form-group" id="detailsProblemes" style="display: none;">
            <label for="descriptionProblemes">Description des probl√®mes</label>
            <textarea id="descriptionProblemes" rows="3" placeholder="D√©taillez les d√©g√¢ts ou probl√®mes constat√©s..." style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary); resize: vertical;"></textarea>
          </div>
          
          <div class="form-group">
            <label>Nettoyage effectu√© ?</label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="nettoyage" value="Oui" checked>
                <span class="radio-custom"></span>
                <span class="radio-text">‚úÖ Oui, effectu√©</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="nettoyage" value="Non">
                <span class="radio-custom"></span>
                <span class="radio-text">‚ùå Non effectu√©</span>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label>Photos fin de service <small>(max 3)</small></label>
            <div class="photo-upload">
              <input type="file" id="photoFinService" accept="image/*" capture="environment" multiple>
              <label for="photoFinService" class="photo-label">
                üì∑ Ajouter photo(s) fin de service
              </label>
              
              <!-- Bouton mobile pour ajouter photos successives -->
              <div class="mobile-photo-controls" style="margin-top: var(--spacing-sm); display: none;">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('photoFinService').click()">
                  üì∑ Ajouter une photo (<span id="photoCount">0/3</span>)
                </button>
              </div>
              
              <div class="photo-preview" id="previewFinService"></div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="commentairesFinaux">Commentaires g√©n√©raux</label>
            <textarea id="commentairesFinaux" rows="4" placeholder="Observations g√©n√©rales sur la tourn√©e, incidents, suggestions..." style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-primary); border-radius: 6px; background: var(--bg-primary); resize: vertical;"></textarea>
          </div>
        </div>
        
        <!-- Validation finale -->
        <div class="form-card" style="background: var(--accent-light); border: 2px solid var(--accent-primary);">
          <h3 style="color: var(--accent-primary);">üéØ Validation Finale</h3>
          
          <div class="form-group">
            <label class="radio-option" style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: 8px;">
              <input type="checkbox" id="confirmationComplete" required>
              <span class="radio-custom"></span>
              <span class="radio-text" style="font-weight: 600;">
                ‚úÖ Je confirme que tous les contr√¥les ont √©t√© effectu√©s et que la tourn√©e est termin√©e
              </span>
            </label>
          </div>
          
          <button class="btn btn-success" onclick="terminerService()" style="font-size: 1.2rem; padding: var(--spacing-lg); width: 100%;">
            üèÅ Terminer le Service
          </button>
        </div>
        
        <!-- Navigation -->
        <div class="main-navigation">
          <button class="btn btn-secondary" onclick="showSection('phase2')">
            ‚Üê Retour Livraisons
          </button>
        </div>
      </div>
    </section>
    
    <!-- ============================================ -->
    <!-- üîÑ SECTION REPRISE SESSION -->
    <!-- ============================================ -->
    <section id="resumeSession" class="section">
      <h2 class="text-center mb-lg">üîÑ Reprendre une Session</h2>
      
      <div style="background: white; padding: var(--spacing-lg); border-radius: var(--radius-lg); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        
        <div class="mb-lg">
          <label for="sessionId" style="display: block; font-weight: 500; margin-bottom: var(--spacing-sm); color: var(--text-primary);">
            ID de Session
          </label>
          <input 
            type="text" 
            id="sessionId" 
            placeholder="Ex: PS_1755116788394_DWAXAW"
            style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--bg-tertiary); border-radius: var(--radius-md); font-size: 1rem;"
          >
        </div>
        
        <button class="btn btn-primary mb-md" onclick="resumeSession()">
          üîÑ Reprendre Session
        </button>
        
        <button class="btn btn-secondary" onclick="showSection('home')">
          üè† Retour Accueil
        </button>
        
      </div>
      
    </section>
    
    <!-- ============================================ -->
    <!-- üìä SECTION HISTORIQUE -->
    <!-- ============================================ -->
    <section id="sessionHistory" class="section">
      <h2 class="text-center mb-lg">üìä Historique des Sessions</h2>
      
      <div class="text-center">
        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
          Liste des sessions pr√©c√©dentes (√† d√©velopper).
        </p>
        
        <button class="btn btn-secondary" onclick="showSection('home')">
          üè† Retour Accueil
        </button>
      </div>
      
    </section>
    
  </div>
  
  <!-- ============================================ -->
  <!-- üöÄ JAVASCRIPT SPA -->
  <!-- ============================================ -->
  <script>
    console.log('üöÄ D√©but chargement JavaScript...');
    
    // Test de syntaxe de base
    try {
      console.log('‚úÖ JavaScript basic test OK');
      
      // Test des template literals probl√©matiques
      var testVar = 'test';
      var result1 = 'Concatenation: ' + testVar;
      console.log('‚úÖ Concatenation test OK');
      
      // Test des fonctions
      function testFunction() {
        return 'Function test OK';
      }
      console.log('‚úÖ', testFunction());
      
    } catch(e) {
      console.error('‚ùå JavaScript basic test FAIL:', e);
      alert('ERREUR JavaScript: ' + e.message);
    }
    
    // ============================================
    // üì± VARIABLES GLOBALES SPA
    // ============================================
    
    let currentSection = 'home';
    let sessionData = {};
    let appState = {
      isConnected: false,
      conducteur: null,
      session: null,
      currentPhase: 0
    };
    
    // ============================================
    // üß≠ NAVIGATION SPA
    // ============================================
    
    function showSection(sectionId) {
      console.log('üß≠ Navigation vers:', sectionId);
      console.log('‚úÖ showSection est d√©finie et appelable');
      
      // üîù RETOUR HAUT DE PAGE
      window.scrollTo(0, 0);
      
      // Masquer toutes les sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      // D√©sactiver tous les nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Afficher la section demand√©e
      const targetSection = document.getElementById(sectionId);
      if (targetSection) {
        targetSection.classList.add('active');
        currentSection = sectionId;
        
        // Activer le nav item correspondant
        const navItem = document.getElementById('nav-' + sectionId);
        if (navItem) {
          navItem.classList.add('active');
        }
        
        // Actions sp√©cifiques par section
        onSectionChange(sectionId);
      } else {
        console.error('‚ùå Section introuvable:', sectionId);
      }
    }
    
    function onSectionChange(sectionId) {
      // Actions √† ex√©cuter lors du changement de section
      switch(sectionId) {
        case 'phase0':
          initPhase0();
          break;
        case 'phase1':
          initPhase1();
          break;
        case 'phase2':
          initPhase2();
          break;
        case 'phase3':
          initPhase3();
          break;
        case 'resumeSession':
          loadRecentSessions();
          break;
        case 'sessionHistory':
          loadSessionHistory();
          break;
      }
    }
    
    // ============================================
    // üöÄ ACTIONS PRINCIPALES
    // ============================================
    
    function startNewTour() {
      console.log('üöÄ D√©marrage nouvelle tourn√©e');
      console.log('‚úÖ startNewTour est d√©finie et appelable');
      
      // R√©initialiser les donn√©es
      sessionData = {};
      appState = {
        isConnected: false,
        conducteur: null,
        session: null,
        currentPhase: 0
      };
      
      // Nettoyer localStorage
      localStorage.removeItem('currentSessionId');
      localStorage.removeItem('phase0_data');
      localStorage.removeItem('phase1_data');
      localStorage.removeItem('phase2_data');
      localStorage.removeItem('phase3_data');
      
      // Aller √† la connexion
      showSection('phase0');
    }
    
    function resumeSession() {
      const sessionId = document.getElementById('sessionId').value.trim();
      
      if (!sessionId) {
        alert('‚ö†Ô∏è Veuillez saisir un ID de session');
        return;
      }
      
      console.log('üîÑ Reprise session:', sessionId);
      
      // Rechercher la session (√† impl√©menter)
      // Pour l'instant, simulation
      alert('üîÑ Fonction de reprise en d√©veloppement...');
    }
    
    // ============================================
    // üë§ PHASE 0 - CONNEXION CONDUCTEUR
    // ============================================
    
    function initPhase0() {
      console.log('üë§ Initialisation Phase 0');
      
      // Focus automatique sur le champ code
      setTimeout(() => {
        const codeInput = document.getElementById('conducteurCode');
        if (codeInput) {
          codeInput.focus();
        }
      }, 300);
    }
    
    function connectConducteur() {
      const code = document.getElementById('conducteurCode').value.trim();
      
      if (!code || code.length !== 4) {
        alert('‚ö†Ô∏è Veuillez saisir un code conducteur valide (4 chiffres)');
        return;
      }
      
      console.log('üîê Connexion conducteur:', code);
      
      // D√©sactiver le bouton pendant la requ√™te
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'üîÑ Connexion...';
      
      // Appel backend avec la fonction existante
      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(onConducteurConnected)
          .withFailureHandler(onConducteurError)
          .getConducteurInfo(code);
      } else {
        // Mode d√©veloppement - simulation avec donn√©es r√©alistes
        setTimeout(() => {
          if (code === '1001') {
            onConducteurConnected({
              conducteur: {
                id: '1001',
                nom: 'conducteur_exemple1',
                prenom: 'Jean',
                email: 'jean.exemple1@transport.com',
                telephone: 601020304,
                site: 'LIDL-Chanteloup',
                statut: 'Actif'
              },
              vehicules: [
                { immatriculation: 'CL-532-ZD', type: 'Tracteur' },
                { immatriculation: 'FG-193-WS', type: 'Remorque' }
              ]
            });
          } else if (code === '1002') {
            onConducteurConnected({
              conducteur: {
                id: '1002',
                nom: 'conducteur_exemple2',
                prenom: 'Marie',
                site: 'ITM-Louviers'
              },
              vehicules: []
            });
          } else {
            onConducteurError({ message: 'Code conducteur non trouv√©' });
          }
        }, 1000);
      }
    }
    
    function onConducteurConnected(result) {
      console.log('‚úÖ Conducteur connect√©:', result);
      
      // R√©activer le bouton
      const btn = document.querySelector('#phase0 .btn-primary');
      btn.disabled = false;
      btn.textContent = 'üîê Se Connecter';
      
      if (result.error) {
        onConducteurError(result);
        return;
      }
      
      // Sauvegarder les donn√©es
      appState.isConnected = true;
      appState.conducteur = result.conducteur;
      sessionData.conducteur = result.conducteur;
      sessionData.vehicules = result.vehicules; // Liste compl√®te des v√©hicules disponibles
      sessionData.tournee = {}; // Sera rempli lors de la s√©lection
      sessionData.selected = {}; // Sera rempli lors de la s√©lection
      
      // Afficher le r√©sultat
      showConducteurResult(result);
      
      // G√©n√©rer session ID
      const sessionId = generateSessionId();
      appState.session = sessionId;
      sessionData.sessionId = sessionId; // ‚≠ê AJOUT CRITIQUE!
      localStorage.setItem('currentSessionId', sessionId);
      
      // Plus de pop-up automatique - l'utilisateur doit s√©lectionner les v√©hicules d'abord
      console.log('‚úÖ Connexion r√©ussie - affichage s√©lection v√©hicules');
    }
    
    function onConducteurError(error) {
      console.error('‚ùå Erreur connexion:', error);
      
      // R√©activer le bouton
      const btn = document.querySelector('#phase0 .btn-primary');
      btn.disabled = false;
      btn.textContent = 'üîê Se Connecter';
      
      // Afficher l'erreur
      let message = 'Erreur de connexion conducteur';
      if (error.message) {
        message = error.message;
      }
      
      alert('‚ùå ' + message);
    }
    
    function showConducteurResult(result) {
      const resultDiv = document.getElementById('conducteurResult');
      resultDiv.innerHTML = 
        '<div style="background: var(--secondary-color); color: white; padding: var(--spacing-md); border-radius: var(--radius-md); text-align: center;">' +
          '<h4 style="margin-bottom: var(--spacing-sm);">‚úÖ Connexion R√©ussie</h4>' +
          '<p><strong>' + result.conducteur.prenom + ' ' + result.conducteur.nom + '</strong></p>' +
          '<p>' + result.conducteur.site + '</p>' +
          '<small>' + result.vehicules.length + ' v√©hicule(s) disponible(s)</small>' +
        '</div>';
      resultDiv.classList.remove('hidden');
      
      // Remplir les listes de v√©hicules et afficher la s√©lection
      populateVehicleLists(result.vehicules);
      showVehicleSelection();
      
      // Initialiser la date et heure
      initializeTourneeDateTime();
    }
    
    function populateVehicleLists(vehicules) {
      console.log('üöõ Remplissage listes v√©hicules Phase 0');
      
      // Tracteurs
      const tracteurSelect = document.getElementById('selectTracteur');
      if (tracteurSelect && vehicules) {
        tracteurSelect.innerHTML = '<option value="">S√©lectionner un tracteur...</option>';
        vehicules.filter(v => v.type === 'Tracteur').forEach(tracteur => {
          const option = document.createElement('option');
          option.value = tracteur.immatriculation;
          option.textContent = tracteur.immatriculation + ' - ' + tracteur.statut + ' (' + (tracteur.kilometrage || 0) + ' km)';
          tracteurSelect.appendChild(option);
        });
      }
      
      // Remorques
      const remorqueSelect = document.getElementById('selectRemorque');
      if (remorqueSelect && vehicules) {
        remorqueSelect.innerHTML = '<option value="">S√©lectionner une remorque...</option>';
        vehicules.filter(v => v.type === 'Remorque' || v.type === 'Porteur').forEach(remorque => {
          const option = document.createElement('option');
          option.value = remorque.immatriculation;
          option.textContent = remorque.immatriculation + ' - ' + remorque.type + ' - ' + remorque.statut;
          remorqueSelect.appendChild(option);
        });
      }
    }
    
    function showVehicleSelection() {
      const vehicleDiv = document.getElementById('vehicleSelection');
      if (vehicleDiv) {
        vehicleDiv.classList.remove('hidden');
        
        // Scroll vers la s√©lection
        setTimeout(() => {
          vehicleDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
      }
    }
    
    function initializeTourneeDateTime() {
      // Date du jour
      const today = new Date();
      const dateInput = document.getElementById('dateTournee');
      if (dateInput) {
        dateInput.value = today.toISOString().split('T')[0];
      }
      
      // Heure actuelle arrondie √† la demi-heure sup√©rieure
      const now = new Date();
      const minutes = now.getMinutes();
      const roundedMinutes = minutes <= 30 ? 30 : 60;
      if (roundedMinutes === 60) {
        now.setHours(now.getHours() + 1);
        now.setMinutes(0);
      } else {
        now.setMinutes(30);
      }
      
      const timeInput = document.getElementById('heureTournee');
      if (timeInput) {
        timeInput.value = now.toTimeString().slice(0, 5);
      }
    }
    
    function validateVehicleSelection() {
      console.log('‚úÖ Validation s√©lection v√©hicules');
      
      // Validation des champs obligatoires
      const dateTournee = document.getElementById('dateTournee').value;
      const heureTournee = document.getElementById('heureTournee').value;
      const tracteur = document.getElementById('selectTracteur').value;
      const remorque = document.getElementById('selectRemorque').value;
      
      if (!dateTournee) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner la date de la tourn√©e');
        return;
      }
      
      if (!heureTournee) {
        alert('‚ö†Ô∏è Veuillez saisir l\'heure de d√©part');
        return;
      }
      
      if (!tracteur) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner un tracteur');
        return;
      }
      
      if (!remorque) {
        alert('‚ö†Ô∏è Veuillez s√©lectionner une remorque');
        return;
      }
      
      // R√©cup√©rer les donn√©es compl√®tes
      const typeTournee = document.querySelector('input[name="typeTournee"]:checked').value;
      const typeLivraison = document.querySelector('input[name="typeLivraison"]:checked').value;
      const commentaires = document.getElementById('commentairesVehicules').value.trim();
      
      // Compl√©ter les donn√©es de session
      if (!sessionData.tournee) sessionData.tournee = {};
      sessionData.tournee = {
        date: dateTournee,
        heure: heureTournee,
        type: typeTournee,
        livraison: typeLivraison
      };
      
      // Conserver la liste des v√©hicules et ajouter la s√©lection
      if (!sessionData.vehicules) sessionData.vehicules = [];
      sessionData.selected = {
        tracteur: tracteur,
        remorque: remorque,
        commentaires: commentaires
      };
      
      console.log('üöõ V√©hicules s√©lectionn√©s sauvegard√©s:', sessionData.selected);
      
      // Sauvegarder localement
      console.log('üíæ sessionData avant sauvegarde:', sessionData);
      localStorage.setItem('sessionData', JSON.stringify(sessionData));
      
      // Sauvegarder sur Google Sheets (Phase 0)
      savePhase0ToBackend(sessionData);
      
      // Notification et navigation
      const message = '‚úÖ Configuration termin√©e !\n\n' +
        'üìã R√©capitulatif :\n' +
        '‚Ä¢ Conducteur : ' + sessionData.conducteur.prenom + ' ' + sessionData.conducteur.nom + '\n' +
        '‚Ä¢ Date : ' + dateTournee + '\n' +
        '‚Ä¢ Heure : ' + heureTournee + '\n' +
        '‚Ä¢ Tracteur : ' + tracteur + '\n' +
        '‚Ä¢ Remorque : ' + remorque + '\n\n' +
        'üöõ Continuer vers les contr√¥les ?';
      
      if (confirm(message)) {
        console.log('üöõ Navigation vers Phase 1...');
        showSection('phase1');
      }
    }
    
    // ============================================
    // ‚òÅÔ∏è FONCTIONS SAUVEGARDE BACKEND
    // ============================================
    
    function savePhase0ToBackend(data) {
      console.log('‚òÅÔ∏è Sauvegarde Phase 0 vers backend');
      
      const phase0Data = {
        sessionId: data.sessionId,
        conducteur: data.conducteur,
        tournee: data.tournee,
        vehiculesSelected: data.vehiculesSelected,
        timestamp: new Date().toISOString()
      };
      
      // V√©rifier si Google Apps Script est disponible
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        // Appel backend Google Apps Script
        google.script.run
          .withSuccessHandler(onPhase0SaveSuccess)
          .withFailureHandler(onPhase0SaveError)
          .savePhase0Data(phase0Data);
      } else {
        console.log('üîß Mode d√©veloppement - simulation sauvegarde Phase 0');
        // Simuler la sauvegarde en mode dev
        setTimeout(() => {
          onPhase0SaveSuccess({ success: true, message: 'Sauvegarde simul√©e (mode dev)' });
        }, 500);
      }
    }
    
    function onPhase0SaveSuccess(result) {
      console.log('‚úÖ Phase 0 sauvegard√©e:', result);
      // Marquer comme synchronis√©
      localStorage.setItem('phase0_synced', 'true');
      updateSyncStatus();
    }
    
    function onPhase0SaveError(error) {
      console.error('‚ùå Erreur sauvegarde Phase 0:', error);
      // Marquer pour synchronisation ult√©rieure
      localStorage.setItem('phase0_pending_sync', 'true');
      updateSyncStatus();
    }
    
    function updateSyncStatus() {
      const phase0Synced = localStorage.getItem('phase0_synced') === 'true';
      const phase1Synced = localStorage.getItem('phase1_synced') === 'true';
      const phase2Synced = localStorage.getItem('phase2_synced') === 'true';
      const phase3Synced = localStorage.getItem('phase3_synced') === 'true';
      
      const phase0Pending = localStorage.getItem('phase0_pending_sync') === 'true';
      const phase1Pending = localStorage.getItem('phase1_pending_sync') === 'true';
      const phase2Pending = localStorage.getItem('phase2_pending_sync') === 'true';
      const phase3Pending = localStorage.getItem('phase3_pending_sync') === 'true';
      
      // V√©rifier les photos
      const phase1PhotosUploaded = localStorage.getItem('phase1_photos_uploaded') === 'true';
      const phase2PhotosUploaded = localStorage.getItem('phase2_photos_uploaded') === 'true';
      const phase3PhotosUploaded = localStorage.getItem('phase3_photos_uploaded') === 'true';
      
      const phase1PhotosPending = localStorage.getItem('phase1_photos_pending') === 'true';
      const phase2PhotosPending = localStorage.getItem('phase2_photos_pending') === 'true';
      const phase3PhotosPending = localStorage.getItem('phase3_photos_pending') === 'true';
      
      const statusElement = document.getElementById('syncStatus');
      if (!statusElement) return;
      
      const retryButton = document.getElementById('retrySync');
      
      if (phase0Pending || phase1Pending || phase2Pending || phase3Pending || 
          phase1PhotosPending || phase2PhotosPending || phase3PhotosPending) {
        statusElement.textContent = '‚è≥ Sync en attente';
        statusElement.className = 'status-text pending';
        if (retryButton) retryButton.style.display = 'inline-block';
      } else if (phase0Synced || phase1Synced || phase2Synced || phase3Synced ||
                 phase1PhotosUploaded || phase2PhotosUploaded || phase3PhotosUploaded) {
        statusElement.textContent = '‚úÖ Synchronis√©';
        statusElement.className = 'status-text synced';
        if (retryButton) retryButton.style.display = 'none';
      } else {
        statusElement.textContent = 'üì± Local';
        statusElement.className = 'status-text local';
        if (retryButton) retryButton.style.display = 'none';
      }
    }
    
    function savePhase1ToBackend(data) {
      console.log('‚òÅÔ∏è Sauvegarde Phase 1 vers backend');
      console.log('üîç sessionData.tournee:', sessionData.tournee);
      console.log('üîç sessionData complet:', sessionData);
      
      const phase1Data = {
        sessionId: sessionData.sessionId,
        formData: {
          // Donn√©es de tourn√©e de Phase 0
          tour: sessionData.tournee?.type || 'Non d√©fini',
          siteDepart: sessionData.conducteur?.site || 'Non d√©fini',
          // Donn√©es de contr√¥les Phase 1
          ...data
        },
        timestamp: new Date().toISOString()
      };
      
      console.log('üì§ Donn√©es envoy√©es au backend:', phase1Data);
      
      // V√©rifier si Google Apps Script est disponible
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(onPhase1SaveSuccess)
          .withFailureHandler(onPhase1SaveError)
          .savePhase1Data(phase1Data);
      } else {
        console.log('üîß Mode d√©veloppement - simulation sauvegarde Phase 1');
        setTimeout(() => {
          onPhase1SaveSuccess({ success: true, message: 'Sauvegarde simul√©e (mode dev)' });
        }, 500);
      }
    }
    
    function onPhase1SaveSuccess(result) {
      console.log('‚úÖ Phase 1 sauvegard√©e:', result);
      localStorage.setItem('phase1_synced', 'true');
      updateSyncStatus();
    }
    
    function onPhase1SaveError(error) {
      console.error('‚ùå Erreur sauvegarde Phase 1:', error);
      localStorage.setItem('phase1_pending_sync', 'true');
      updateSyncStatus();
    }
    
    function savePhase2ToBackend(data) {
      console.log('‚òÅÔ∏è Sauvegarde Phase 2 vers backend');
      
      // üéØ ENVOI INDIVIDUAL MAGASIN AVEC DONN√âES COMPL√àTES
      if (data.livraisons && data.livraisons.length > 0) {
        // Envoyer chaque magasin individuellement
        data.livraisons.forEach((magasin, index) => {
          const magasinData = {
            sessionId: sessionData.sessionId,
            generalData: {
              dateDepart: sessionData.tournee?.date || new Date().toLocaleDateString('fr-FR'),
              cycle: sessionData.tournee?.type || '',
              typeLivraison: sessionData.tournee?.livraison || '',
              siteChargement: sessionData.conducteur?.site || '',
              nomConducteur: `${sessionData.conducteur?.prenom || ''} ${sessionData.conducteur?.nom || ''}`.trim(),
              heureDepartPrevue: sessionData.tournee?.heure || '',
              magasinsALivrer: data.livraisons.length.toString()
            },
            magasin: {
              ...magasin,
              index: index
            }
          };
          
          console.log('üì§ Envoi magasin ' + (index + 1) + ':', magasinData);
          
          google.script.run
            .withSuccessHandler(onPhase2SaveSuccess)
            .withFailureHandler(onPhase2SaveError)
            .saveSingleMagasin(magasinData);
        });
        return;
      }
      
      const phase2Data = {
        sessionId: sessionData.sessionId,
        // Donn√©es de Phase 2 avec livraisons
        magasins: data.livraisons || [],
        livraisons: data.livraisons || [],
        dateDepart: sessionData.tournee?.date || new Date().toLocaleDateString('fr-FR'),
        heureDepart: sessionData.tournee?.heure || new Date().toTimeString().slice(0,5),
        ...data,
        timestamp: new Date().toISOString()
      };
      
      // V√©rifier si Google Apps Script est disponible
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(onPhase2SaveSuccess)
          .withFailureHandler(onPhase2SaveError)
          .savePhase2Data(phase2Data);
      } else {
        console.log('üîß Mode d√©veloppement - simulation sauvegarde Phase 2');
        setTimeout(() => {
          onPhase2SaveSuccess({ success: true, message: 'Sauvegarde simul√©e (mode dev)' });
        }, 500);
      }
    }
    
    function onPhase2SaveSuccess(result) {
      console.log('‚úÖ Phase 2 sauvegard√©e:', result);
      localStorage.setItem('phase2_synced', 'true');
      updateSyncStatus();
    }
    
    function onPhase2SaveError(error) {
      console.error('‚ùå Erreur sauvegarde Phase 2:', error);
      localStorage.setItem('phase2_pending_sync', 'true');
      updateSyncStatus();
    }
    
    function savePhase3ToBackend(data) {
      console.log('‚òÅÔ∏è Sauvegarde Phase 3 vers backend');
      
      const phase3Data = {
        sessionId: sessionData.sessionId,
        // Donn√©es de tourn√©e de Phase 0 pour Phase 3
        siteAffectation: sessionData.conducteur?.site || 'Non d√©fini',
        tourContratFin: sessionData.tournee?.type || 'Non d√©fini', 
        heureRetour: data.heureRetour || new Date().toTimeString().slice(0,5),
        ...data,
        timestamp: new Date().toISOString()
      };
      
      // V√©rifier si Google Apps Script est disponible
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(onPhase3SaveSuccess)
          .withFailureHandler(onPhase3SaveError)
          .savePhase3Data(phase3Data);
      } else {
        console.log('üîß Mode d√©veloppement - simulation sauvegarde Phase 3');
        setTimeout(() => {
          onPhase3SaveSuccess({ success: true, message: 'Sauvegarde simul√©e (mode dev)' });
        }, 500);
      }
    }
    
    function onPhase3SaveSuccess(result) {
      console.log('‚úÖ Phase 3 sauvegard√©e:', result);
      localStorage.setItem('phase3_synced', 'true');
      localStorage.setItem('session_fully_synced', 'true');
      updateSyncStatus();
    }
    
    function onPhase3SaveError(error) {
      console.error('‚ùå Erreur sauvegarde Phase 3:', error);
      localStorage.setItem('phase3_pending_sync', 'true');
      updateSyncStatus();
    }
    
    // ============================================
    // üì∑ FONCTIONS UPLOAD PHOTOS GOOGLE DRIVE
    // ============================================
    
    function uploadPhotosToGoogleDrive(photos, sessionId, phase) {
      console.log('üì∑ Upload ' + Object.keys(photos).length + ' photos Phase ' + phase + ' vers Google Drive');
      
      if (!photos || Object.keys(photos).length === 0) {
        console.log('üì∑ Aucune photo √† uploader');
        return Promise.resolve([]);
      }
      
      const photoPromises = [];
      
      Object.entries(photos).forEach(([photoId, photoData]) => {
        const uploadData = {
          sessionId: sessionId,
          phase: phase,
          photoId: photoId,
          photoData: photoData.data || photoData, // Base64
          fileName: photoData.name || photoData.fileName || (photoId + '.jpg'),
          fileSize: photoData.size || photoData.fileSize || 0,
          timestamp: photoData.timestamp || new Date().toISOString()
        };
        
        console.log('üì∑ Upload data pour ' + photoId + ':', {
          sessionId: uploadData.sessionId,
          fileName: uploadData.fileName,
          fileSize: uploadData.fileSize,
          dataLength: uploadData.photoData ? uploadData.photoData.length : 0
        });
        
        const promise = new Promise((resolve, reject) => {
          // V√©rifier si Google Apps Script est disponible
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler((result) => {
                console.log('‚úÖ Photo ' + photoId + ' upload√©e:', result);
                resolve(result);
              })
              .withFailureHandler((error) => {
                console.error('‚ùå Erreur upload photo ' + photoId + ':', error);
                reject(error);
              })
              .savePhotosToDrive(
                { [photoId]: { 
                  data: uploadData.photoData.split(',')[1], // Retirer le pr√©fixe data:image/...;base64,
                  name: uploadData.fileName,
                  type: photoData.type || 'image/jpeg',
                  size: uploadData.fileSize
                } }, 
                uploadData.sessionId, 
                uploadData.phase
              );
          } else {
            console.log('üîß Mode d√©veloppement - simulation upload photo ' + photoId);
            // Simuler l'upload en mode dev
            setTimeout(() => {
              resolve({ 
                success: true, 
                photoId: photoId,
                url: 'https://drive.google.com/simulated/' + photoId,
                message: 'Upload simul√© (mode dev)'
              });
            }, 100);
          }
        });
        
        photoPromises.push(promise);
      });
      
      return Promise.allSettled(photoPromises);
    }
    
    function uploadPhase1Photos() {
      const phase1Data = JSON.parse(localStorage.getItem('phase1_data') || '{}');
      const sessionId = sessionData.sessionId;
      
      if (phase1Data.photos) {
        uploadPhotosToGoogleDrive(phase1Data.photos, sessionId, 1)
          .then(results => {
            console.log('üì∑ Upload Phase 1 termin√©:', results);
            const successful = results.filter(r => r.status === 'fulfilled').length;
            const failed = results.filter(r => r.status === 'rejected').length;
            
            if (successful > 0) {
              localStorage.setItem('phase1_photos_uploaded', 'true');
              console.log('‚úÖ ' + successful + ' photos Phase 1 upload√©es avec succ√®s');
              
              // üéØ NOUVELLE MAGIE : R√©cup√©rer les URLs et sauvegarder dans Sheets
              const photoUrls = {};
              results.forEach(result => {
                if (result.status === 'fulfilled' && result.value) {
                  // Les URLs sont dans result.value avec les cl√©s photoCarburant, etc.
                  Object.assign(photoUrls, result.value);
                }
              });
              
              console.log('üîó URLs r√©cup√©r√©es pour Sheets:', photoUrls);
              
              // Sauvegarder dans Sheets avec les URLs
              const dataForSheets = {
                ...phase1Data,
                sessionId: sessionId,
                formData: phase1Data
              };
              
              console.log('üì§ Donn√©es envoy√©es pour Sheets:', dataForSheets);
              console.log('üí¨ Commentaires envoy√©s:', {
                commentairesTracteur: dataForSheets.commentairesTracteur,
                commentairesRemorque: dataForSheets.commentairesRemorque,
                commentairesFinaux: dataForSheets.commentairesFinaux
              });
              
              google.script.run
                .withSuccessHandler((sheetResult) => {
                  console.log('üìä ‚úÖ SAUVEGARDE SHEETS FINALE R√âUSSIE:', sheetResult);
                })
                .withFailureHandler((sheetError) => {
                  console.error('üìä ‚ùå Erreur sauvegarde Sheets finale:', sheetError);
                })
                .savePhase1ToSheetsWithUrls(dataForSheets, photoUrls);
            }
            
            if (failed > 0) {
              console.error('‚ùå ' + failed + ' photos Phase 1 ont √©chou√©');
              localStorage.setItem('phase1_photos_pending', 'true');
            }
          })
          .catch(error => {
            console.error('‚ùå Erreur globale upload Phase 1:', error);
            localStorage.setItem('phase1_photos_pending', 'true');
          });
      }
    }
    
    function uploadPhase2Photos() {
      const phase2Data = JSON.parse(localStorage.getItem('phase2_data') || '{}');
      const sessionId = sessionData.sessionId;
      
      if (phase2Data.photos) {
        uploadPhotosToGoogleDrive(phase2Data.photos, sessionId, 2)
          .then(results => {
            console.log('üì∑ Upload Phase 2 termin√©:', results);
            const successful = results.filter(r => r.status === 'fulfilled').length;
            const failed = results.filter(r => r.status === 'rejected').length;
            
            if (successful > 0) {
              localStorage.setItem('phase2_photos_uploaded', 'true');
              console.log('‚úÖ ' + successful + ' photos Phase 2 upload√©es avec succ√®s');
            }
            
            if (failed > 0) {
              console.error('‚ùå ' + failed + ' photos Phase 2 ont √©chou√©');
              localStorage.setItem('phase2_photos_pending', 'true');
            }
          })
          .catch(error => {
            console.error('‚ùå Erreur globale upload Phase 2:', error);
            localStorage.setItem('phase2_photos_pending', 'true');
          });
      }
    }
    
    function uploadPhase3Photos() {
      const sessionId = sessionData.sessionId;
      
      if (phase3Data.photos) {
        uploadPhotosToGoogleDrive(phase3Data.photos, sessionId, 3)
          .then(results => {
            console.log('üì∑ Upload Phase 3 termin√©:', results);
            const successful = results.filter(r => r.status === 'fulfilled').length;
            const failed = results.filter(r => r.status === 'rejected').length;
            
            if (successful > 0) {
              localStorage.setItem('phase3_photos_uploaded', 'true');
              console.log('‚úÖ ' + successful + ' photos Phase 3 upload√©es avec succ√®s');
            }
            
            if (failed > 0) {
              console.error('‚ùå ' + failed + ' photos Phase 3 ont √©chou√©');
              localStorage.setItem('phase3_photos_pending', 'true');
            }
          })
          .catch(error => {
            console.error('‚ùå Erreur globale upload Phase 3:', error);
            localStorage.setItem('phase3_photos_pending', 'true');
          });
      }
    }
    
    function uploadAllPendingPhotos() {
      console.log('üì∑ Upload de toutes les photos en attente');
      
      const phase1Pending = localStorage.getItem('phase1_photos_pending') === 'true';
      const phase2Pending = localStorage.getItem('phase2_photos_pending') === 'true';
      const phase3Pending = localStorage.getItem('phase3_photos_pending') === 'true';
      
      if (phase1Pending) {
        uploadPhase1Photos();
        localStorage.removeItem('phase1_photos_pending');
      }
      
      if (phase2Pending) {
        uploadPhase2Photos();
        localStorage.removeItem('phase2_photos_pending');
      }
      
      if (phase3Pending) {
        uploadPhase3Photos();
        localStorage.removeItem('phase3_photos_pending');
      }
      
      if (!phase1Pending && !phase2Pending && !phase3Pending) {
        console.log('üì∑ Aucune photo en attente d\'upload');
      }
    }
    
    // ============================================
    // üöõ PHASES 1-2-3 (√Ä D√âVELOPPER)
    // ============================================
    
    function initPhase1() {
      console.log('üöõ Initialisation Phase 1');
      
      if (!appState.isConnected) {
        alert('‚ö†Ô∏è Veuillez d\'abord vous connecter');
        showSection('phase0');
        return;
      }
      
      // Charger les donn√©es Phase 0 dans le r√©capitulatif
      loadPhase1Data();
      
      // Initialiser la premi√®re √©tape
      currentPhase1Step = 1;
      showPhase1Step(1);
      updatePhase1Progress();
    }
    
    function populatePhase1VehicleSelects() {
      console.log('üöõ Remplissage v√©hicules Phase 1 (inputs readonly)');
      
      // Les v√©hicules sont maintenant en readonly et pr√©-remplis
      // Cette fonction est conserv√©e pour compatibilit√© mais ne fait plus rien
      // car les inputs sont pr√©-remplis directement dans loadPhase1Data()
    }
    
    // ============================================
    // üöõ PHASE 1 - GESTION DES √âTAPES
    // ============================================
    
    let currentPhase1Step = 1;
    const totalPhase1Steps = 6;
    let phase1Data = {};
    
    function loadPhase1Data() {
      console.log('üìä Chargement donn√©es Phase 1');
      
      // Charger sessionData depuis localStorage si vide
      if (!sessionData.sessionId) {
        const storedSessionData = localStorage.getItem('sessionData');
        if (storedSessionData) {
          sessionData = JSON.parse(storedSessionData);
          console.log('üîÑ sessionData recharg√© depuis localStorage:', sessionData);
        }
      }
      
      if (appState.conducteur && sessionData.conducteur) {
        document.getElementById('recapConducteur').textContent = sessionData.conducteur.prenom + ' ' + sessionData.conducteur.nom;
        document.getElementById('recapSite').textContent = sessionData.conducteur.site;
      }
      
      // Simuler donn√©es de tourn√©e (Phase 0 pourrait les fournir)
      document.getElementById('recapDate').textContent = new Date().toLocaleDateString('fr-FR');
      document.getElementById('recapHeure').textContent = new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
      document.getElementById('recapTour').textContent = '1er Tour';
      
      // Populer les selects avec les v√©hicules disponibles et pr√©-remplir
      populatePhase1VehicleSelects();
      
      // Pr√©-remplir avec les v√©hicules s√©lectionn√©s en Phase 0
      if (sessionData.vehiculesSelected) {
        const tracteurInput = document.getElementById('immatTracteur');
        const remorqueInput = document.getElementById('immatRemorque');
        
        if (tracteurInput && sessionData.vehiculesSelected.tracteur) {
          tracteurInput.value = sessionData.vehiculesSelected.tracteur;
          console.log('üöõ Tracteur pr√©-rempli:', sessionData.vehiculesSelected.tracteur);
        }
        
        if (remorqueInput && sessionData.vehiculesSelected.remorque) {
          remorqueInput.value = sessionData.vehiculesSelected.remorque;
          console.log('üöõ Remorque pr√©-remplie:', sessionData.vehiculesSelected.remorque);
        }
      }
      document.getElementById('recapType').textContent = 'Frais';
      
      // V√©hicules depuis sessionData si disponibles
      if (sessionData.vehicules && sessionData.vehicules.length > 0) {
        const tracteur = sessionData.vehicules.find(v => v.type === 'Tracteur');
        const remorque = sessionData.vehicules.find(v => v.type === 'Remorque');
        
        document.getElementById('recapTracteur').textContent = tracteur ? tracteur.immatriculation : 'Non s√©lectionn√©';
        document.getElementById('recapRemorque').textContent = remorque ? remorque.immatriculation : 'Non s√©lectionn√©';
        
        // Pr√©-remplir les champs
        if (tracteur) {
          document.getElementById('immatTracteur').value = tracteur.immatriculation;
        }
      }
    }
    
    function showPhase1Step(stepNumber) {
      console.log('üöõ Affichage √©tape ' + stepNumber + '/' + totalPhase1Steps);
      
      // üîù RETOUR HAUT DE PAGE POUR LES √âTAPES
      window.scrollTo(0, 0);
      
      // Masquer toutes les √©tapes
      document.querySelectorAll('.step-container').forEach(step => {
        step.classList.remove('active');
      });
      
      // Afficher l'√©tape demand√©e
      const stepElement = document.getElementById('step' + stepNumber);
      if (stepElement) {
        stepElement.classList.add('active');
        currentPhase1Step = stepNumber;
        updatePhase1Progress();
        
        // üìä Mettre √† jour le r√©capitulatif si c'est l'√©tape finale
        if (stepNumber === 6) {
          setTimeout(updateFinalRecap, 100); // Petit d√©lai pour que DOM soit pr√™t
        }
      }
    }
    
    function updatePhase1Progress() {
      const progressPercent = (currentPhase1Step / totalPhase1Steps) * 100;
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      if (progressFill) {
        progressFill.style.width = progressPercent + '%';
      }
      
      if (progressText) {
        progressText.textContent = '√âtape ' + currentPhase1Step + ' sur ' + totalPhase1Steps;
      }
    }
    
    function nextPhase1Step() {
      if (validatePhase1Step(currentPhase1Step)) {
        savePhase1StepData(currentPhase1Step);
        
        if (currentPhase1Step < totalPhase1Steps) {
          showPhase1Step(currentPhase1Step + 1);
        } else {
          // Phase 1 termin√©e
          completePhase1();
        }
      }
    }
    
    function prevPhase1Step() {
      if (currentPhase1Step > 1) {
        showPhase1Step(currentPhase1Step - 1);
      }
    }
    
    function validatePhase1Step(stepNumber) {
      // Validation basique - √† compl√©ter selon les besoins
      switch(stepNumber) {
        case 1:
          const numeroContrat = document.getElementById('numeroContrat').value.trim();
          if (!numeroContrat) {
            alert('‚ö†Ô∏è Veuillez saisir le num√©ro de contrat ou tour');
            return false;
          }
          break;
        case 2:
          const kilometrage = document.getElementById('kilometrage').value.trim();
          if (!kilometrage) {
            alert('‚ö†Ô∏è Veuillez saisir le kilom√©trage');
            return false;
          }
          break;
        case 4:
          // V√©rifier photo hayon obligatoire
          if (!phase1Data.photos || !phase1Data.photos['photoHayon']) {
            alert('‚ö†Ô∏è La photo du hayon d√©ploy√© est obligatoire');
            return false;
          }
          break;
        case 6:
          const heureDepart = document.getElementById('heureDepart').value.trim();
          if (!heureDepart) {
            alert('‚ö†Ô∏è Veuillez saisir l\'heure de d√©part r√©elle');
            return false;
          }
          break;
      }
      return true;
    }
    
    function savePhase1StepData(stepNumber) {
      console.log('üíæ Sauvegarde donn√©es √©tape ' + stepNumber);
      
      switch(stepNumber) {
        case 1:
          phase1Data.numeroContrat = document.getElementById('numeroContrat').value.trim();
          break;
        case 2:
          phase1Data.immatTracteur = document.getElementById('immatTracteur').value;
          phase1Data.degatsTracteur = document.querySelector('input[name="degatsTracteur"]:checked')?.value;
          phase1Data.detailsDegatsTracteur = document.getElementById('detailsDegatsTracteur').value.trim();
          phase1Data.kilometrage = document.getElementById('kilometrage').value;
          console.log('üí¨ D√©tails d√©g√¢ts tracteur collect√©s:', phase1Data.detailsDegatsTracteur);
          break;
        case 3:
          phase1Data.commentairesTracteur = document.getElementById('commentairesTracteur').value.trim();
          console.log('üí¨ Commentaire tracteur collect√©:', phase1Data.commentairesTracteur);
          break;
        case 4:
          phase1Data.immatRemorque = document.getElementById('immatRemorque').value;
          phase1Data.degatsRemorque = document.querySelector('input[name="degatsRemorque"]:checked')?.value;
          phase1Data.detailsDegatsRemorque = document.getElementById('detailsDegatsRemorque').value.trim();
          phase1Data.commentairesRemorque = document.getElementById('commentairesRemorque').value.trim();
          console.log('üí¨ D√©tails d√©g√¢ts remorque collect√©s:', phase1Data.detailsDegatsRemorque);
          console.log('üí¨ Commentaire remorque collect√©:', phase1Data.commentairesRemorque);
          break;
        case 5:
          phase1Data.chargementConforme = document.querySelector('input[name="chargementConforme"]:checked')?.value;
          phase1Data.commentairesChargement = document.getElementById('commentairesChargement').value.trim();
          console.log('üí¨ Commentaire chargement collect√©:', phase1Data.commentairesChargement);
          break;
        case 6:
          phase1Data.heureDepart = document.getElementById('heureDepart').value;
          phase1Data.commentairesFinaux = document.getElementById('commentairesFinaux').value.trim();
          console.log('üí¨ Commentaire final collect√©:', phase1Data.commentairesFinaux);
          updateFinalRecap();
          break;
      }
      
      // Sauvegarder localement
      try {
        localStorage.setItem('phase1_data', JSON.stringify(phase1Data));
      } catch (e) {
        console.warn('‚ö†Ô∏è localStorage plein - sauvegarde √©tape sans photos volumineuses');
        // Retirer les data photos volumineuses
        const cleanData = {...phase1Data};
        if (cleanData.photos) {
          Object.keys(cleanData.photos).forEach(photoId => {
            if (cleanData.photos[photoId].data) {
              delete cleanData.photos[photoId].data;
              cleanData.photos[photoId].storedOnServer = true;
            }
          });
        }
        try {
          localStorage.setItem('phase1_data', JSON.stringify(cleanData));
        } catch (e2) {
          console.error('‚ùå Impossible de sauvegarder phase1_data');
        }
      }
      
      // Sauvegarder sur Google Sheets
      savePhase1ToBackend(phase1Data);
    }
    
    function updateFinalRecap() {
      console.log('üìä Mise √† jour r√©capitulatif final');
      
      // Compter les photos prises (en tenant compte du nettoyage localStorage)
      let photosCount = 0;
      if (phase1Data.photos) {
        photosCount = Object.keys(phase1Data.photos).length;
      }
      
      // Si les photos ont √©t√© nettoy√©es du localStorage, compter les inputs avec des fichiers
      if (photosCount === 0) {
        const photoInputs = document.querySelectorAll('#phase1 input[type="file"]');
        photoInputs.forEach(input => {
          if (input.files && input.files.length > 0) {
            photosCount++;
          }
        });
        console.log('üì∑ Photos compt√©es depuis les inputs:', photosCount);
      } else {
        console.log('üì∑ Photos compt√©es depuis phase1Data:', photosCount);
      }
      
      const finalPhotosElement = document.getElementById('finalPhotosCount');
      if (finalPhotosElement) {
        finalPhotosElement.textContent = photosCount;
        console.log('üìä Compteur photos mis √† jour:', photosCount);
      }
      
      // R√©sumer les d√©g√¢ts
      const degats = [];
      if (phase1Data.degatsTracteur === 'Oui') degats.push('Tracteur');
      if (phase1Data.degatsRemorque === 'Oui') degats.push('Remorque');
      
      const finalDegatsElement = document.getElementById('finalDegats');
      if (finalDegatsElement) {
        finalDegatsElement.textContent = degats.length > 0 ? degats.join(', ') : 'Aucun';
      }
      
      // √âtat du chargement
      const finalChargementElement = document.getElementById('finalChargement');
      if (finalChargementElement) {
        finalChargementElement.textContent = phase1Data.chargementConforme || 'Conforme';
      }
    }
    
    function completePhase1() {
      console.log('‚úÖ Phase 1 termin√©e');
      
      // Validation finale
      if (!validatePhase1Step(6)) {
        return;
      }
      
      // Sauvegarder donn√©es finales
      savePhase1StepData(6);
      
      // Marquer comme termin√©e
      localStorage.setItem('phase1_completed', 'true');
      phase1Data.completed = true;
      phase1Data.completedAt = new Date().toISOString();
      localStorage.setItem('phase1_data', JSON.stringify(phase1Data));
      
      // Upload des photos Phase 1
      uploadPhase1Photos();
      
      // Afficher bouton Phase 2
      const btnPhase2 = document.getElementById('btnPhase2');
      if (btnPhase2) {
        btnPhase2.style.display = 'block';
      }
      
      // Notification de succ√®s
      const photosCount = phase1Data.photos ? Object.keys(phase1Data.photos).length : 0;
      const message = `‚úÖ Phase 1 - Contr√¥les termin√©e !
      
üìä R√©capitulatif :
‚Ä¢ ${photosCount} photo(s) prise(s)
‚Ä¢ Kilom√©trage : ${phase1Data.kilometrage || 'Non renseign√©'} km
‚Ä¢ Heure d√©part : ${phase1Data.heureDepart || 'Non renseign√©e'}

üöõ Vous pouvez maintenant passer aux livraisons.`;
      
      alert(message);
      
      // Proposer de passer √† Phase 2
      setTimeout(() => {
        if (confirm('üì¶ Voulez-vous continuer vers le suivi des livraisons ?')) {
          showSection('phase2');
        }
      }, 1000);
    }
    
    // ============================================
    // üöõ PHASE 1 - GESTION PHOTOS
    // ============================================
    
    function setupPhase1PhotoUpload() {
      const photoInputs = document.querySelectorAll('#phase1 input[type="file"]');
      
      photoInputs.forEach(input => {
        input.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            handlePhase1Photo(file, input.id);
          }
        });
      });
      
      console.log('üì∑ ' + photoInputs.length + ' inputs photo configur√©s pour Phase 1');
    }
    
    function handlePhase1Photo(file, inputId) {
      console.log('üì∑ Traitement photo: ' + inputId + ' (' + (file.size / 1024).toFixed(1) + ' KB)');
      
      // V√©rifier la taille du fichier (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('‚ö†Ô∏è La photo est trop volumineuse (max 5MB)');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const previewId = inputId.replace('photo', 'preview');
        const previewElement = document.getElementById(previewId);
        
        // üì∑ GESTION PHOTOS MULTIPLES : V√©rifier si une photo existe d√©j√†
        let photoKey = inputId;
        let photoCounter = 1;
        
        if (!phase1Data.photos) {
          phase1Data.photos = {};
        }
        
        // Si la photo existe d√©j√†, cr√©er une nouvelle cl√© avec suffixe
        while (phase1Data.photos[photoKey]) {
          photoCounter++;
          photoKey = inputId + '_' + photoCounter;
          console.log('üì∑ Photo ' + inputId + ' existe d√©j√†, nouvelle cl√©: ' + photoKey);
        }
        
        if (previewElement) {
          // Pour les photos multiples, ajouter au lieu de remplacer
          const newPhotoHtml = `
            <div style="display: inline-block; margin: 5px;">
              <img src="${e.target.result}" alt="Photo ${photoKey}" style="max-width: 150px; border-radius: 8px; box-shadow: var(--shadow); border: 1px solid var(--border-primary);">
              <p style="margin-top: var(--spacing-sm); font-size: 10px; color: var(--text-secondary); text-align: center;">
                üì∑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)
              </p>
            </div>
          `;
          
          if (photoCounter === 1) {
            previewElement.innerHTML = newPhotoHtml;
          } else {
            previewElement.innerHTML += newPhotoHtml;
          }
        }
        
        // Sauvegarder dans les donn√©es avec la nouvelle cl√©
        phase1Data.photos[photoKey] = {
          data: e.target.result,
          name: file.name || (inputId + '.jpg'),
          fileName: file.name || (inputId + '.jpg'),
          size: file.size || 0,
          fileSize: file.size || 0,
          timestamp: new Date().toISOString(),
          type: file.type || 'image/jpeg'
        };
        
        console.log('üì∑ Photo ' + inputId + ' sauvegard√©e avec structure:', {
          name: phase1Data.photos[inputId].name,
          fileName: phase1Data.photos[inputId].fileName,
          size: phase1Data.photos[inputId].size,
          dataLength: phase1Data.photos[inputId].data.length
        });
        
        try {
          localStorage.setItem('phase1_data', JSON.stringify(phase1Data));
        } catch (e) {
          console.warn('‚ö†Ô∏è localStorage plein - photo ' + inputId + ' sauvegard√©e c√¥t√© serveur uniquement');
          // Retirer la data volumineuse et garder seulement les m√©tadonn√©es
          if (phase1Data.photos[inputId]) {
            delete phase1Data.photos[inputId].data;
            phase1Data.photos[inputId].storedOnServer = true;
            try {
              localStorage.setItem('phase1_data', JSON.stringify(phase1Data));
            } catch (e2) {
              console.error('‚ùå Impossible de sauvegarder m√™me les m√©tadonn√©es');
            }
          }
        }
        
        console.log('‚úÖ Photo ' + inputId + ' sauvegard√©e');
      };
      
      reader.onerror = function() {
        console.error('‚ùå Erreur lecture photo ' + inputId);
        alert('‚ùå Erreur lors de la lecture de la photo');
      };
      
      reader.readAsDataURL(file);
    }
    
    // ============================================
    // üì¶ PHASE 2 - SUIVI LIVRAISONS
    // ============================================
    
    let phase2Data = {
      livraisons: [],
      photos: {}
    };
    
    function initPhase2() {
      console.log('üì¶ Initialisation Phase 2');
      
      // üîù RETOUR HAUT DE PAGE PHASE 2
      window.scrollTo(0, 0);
      
      // Charger les donn√©es de Phase 1
      loadPhase2Data();
      
      // Configurer les √©v√©nements
      setupPhase2Events();
      
      // Charger les livraisons existantes
      loadExistingLivraisons();
    }
    
    function loadPhase2Data() {
      console.log('üìä Chargement donn√©es Phase 2');
      
      // R√©cup√©rer les donn√©es des phases pr√©c√©dentes
      const sessionStorageData = JSON.parse(localStorage.getItem('sessionData') || '{}');
      const phase1StorageData = JSON.parse(localStorage.getItem('phase1_data') || '{}');
      
      if (sessionStorageData.conducteur) {
        document.getElementById('phase2Conducteur').textContent = 
          `${sessionStorageData.conducteur.prenom} ${sessionStorageData.conducteur.nom}`;
      }
      
      console.log('üîç DEBUG sessionStorageData complet:', sessionStorageData);
      console.log('üîç DEBUG selected:', sessionStorageData.selected);
      
      if (sessionStorageData.selected) {
        const vehicule = `${sessionStorageData.selected.tracteur || 'N/A'} + ${sessionStorageData.selected.remorque || 'N/A'}`;
        document.getElementById('phase2Vehicule').textContent = vehicule;
        console.log('‚úÖ V√©hicules Phase 2:', vehicule);
      } else {
        console.log('‚ùå sessionStorageData.selected manquant');
        document.getElementById('phase2Vehicule').textContent = 'GC-454-QW + FG-193-WS';
      }
      
      if (phase1StorageData.heureDepart) {
        document.getElementById('phase2HeureDepart').textContent = phase1StorageData.heureDepart;
      }
      
      // Charger les donn√©es Phase 2 existantes
      const phase2StorageData = JSON.parse(localStorage.getItem('phase2_data') || '{}');
      if (phase2StorageData.livraisons) {
        phase2Data = phase2StorageData;
      }
    }
    
    function setupPhase2Events() {
      // Gestion du motif de non-livraison
      const radioNon = document.querySelector('input[name="livraisonEffectuee"][value="Non"]');
      const radioOui = document.querySelector('input[name="livraisonEffectuee"][value="Oui"]');
      const motifDiv = document.getElementById('motifNonLivraison');
      
      if (radioNon && radioOui && motifDiv) {
        radioNon.addEventListener('change', () => {
          motifDiv.style.display = 'block';
        });
        
        radioOui.addEventListener('change', () => {
          motifDiv.style.display = 'none';
        });
      }
      
      // Gestion des photos
      const photoInput = document.getElementById('photoMagasin');
      if (photoInput) {
        photoInput.addEventListener('change', handlePhase2Photos);
      }
    }
    
    function handlePhase2Photos(event) {
      const files = Array.from(event.target.files);
      const maxFiles = 3;
      
      if (files.length > maxFiles) {
        alert('‚ö†Ô∏è Maximum ' + maxFiles + ' photos autoris√©es');
        return;
      }
      
      const previewContainer = document.getElementById('previewMagasin');
      previewContainer.innerHTML = '';
      
      files.forEach((file, index) => {
        if (file.size > 5 * 1024 * 1024) {
          alert('‚ö†Ô∏è Photo ' + file.name + ' trop volumineuse (max 5MB)');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const photoDiv = document.createElement('div');
          photoDiv.style.cssText = 'display: inline-block; margin: 5px; position: relative;';
          photoDiv.innerHTML = `
            <img src="${e.target.result}" alt="Photo ${index + 1}" style="max-width: 150px; border-radius: 8px; box-shadow: var(--shadow);">
            <p style="font-size: 10px; text-align: center; margin: 5px 0; color: var(--text-secondary);">
              üì∑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)
            </p>
          `;
          previewContainer.appendChild(photoDiv);
        };
        reader.readAsDataURL(file);
      });
    }
    
    function ajouterLivraison() {
      console.log('‚ûï Ajout nouvelle livraison');
      
      // Validation
      const nomMagasin = document.getElementById('nomMagasin').value.trim();
      const heureLivraison = document.getElementById('heureLivraison').value;
      
      if (!nomMagasin) {
        alert('‚ö†Ô∏è Veuillez saisir le nom du magasin');
        return;
      }
      
      if (!heureLivraison) {
        alert('‚ö†Ô∏è Veuillez saisir l\'heure de livraison');
        return;
      }
      
      // R√©cup√©rer les donn√©es
      const livraison = {
        id: Date.now(),
        nomMagasin: nomMagasin,
        adresse: document.getElementById('adresseMagasin').value.trim(),
        heure: heureLivraison,
        effectuee: document.querySelector('input[name="livraisonEffectuee"]:checked').value,
        motifRefus: document.getElementById('motifRefus').value,
        commentaire: document.getElementById('commentaireLivraison').value.trim(),
        timestamp: new Date().toISOString()
      };
      
      // Ajouter √† la liste
      phase2Data.livraisons.push(livraison);
      
      // Sauvegarder localement
      localStorage.setItem('phase2_data', JSON.stringify(phase2Data));
      
      // Sauvegarder sur Google Sheets
      savePhase2ToBackend(phase2Data);
      
      // R√©initialiser le formulaire
      resetLivraisonForm();
      
      // Mettre √† jour l'affichage
      updateLivraisonsList();
      updateLivraisonsProgress();
      
      // Notification
      alert(`‚úÖ Livraison "${nomMagasin}" ajout√©e !`);
    }
    
    function resetLivraisonForm() {
      document.getElementById('nomMagasin').value = '';
      document.getElementById('adresseMagasin').value = '';
      document.getElementById('heureLivraison').value = '';
      document.getElementById('commentaireLivraison').value = '';
      document.getElementById('motifRefus').value = '';
      document.querySelector('input[name="livraisonEffectuee"][value="Oui"]').checked = true;
      document.getElementById('motifNonLivraison').style.display = 'none';
      document.getElementById('previewMagasin').innerHTML = '';
      document.getElementById('photoMagasin').value = '';
    }
    
    function updateLivraisonsList() {
      const container = document.getElementById('livraisonsContainer');
      
      if (phase2Data.livraisons.length === 0) {
        container.innerHTML = '<p class="empty-state" style="text-align: center; color: var(--text-secondary); padding: var(--spacing-xl);">Aucune livraison enregistr√©e</p>';
        return;
      }
      
      container.innerHTML = phase2Data.livraisons.map(livraison => `
        <div class="livraison-item" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); border-radius: 8px; padding: var(--spacing-md); margin-bottom: var(--spacing-sm);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 var(--spacing-sm) 0; color: var(--text-primary);">
                ${livraison.effectuee === 'Oui' ? '‚úÖ' : '‚ùå'} ${livraison.nomMagasin}
              </h4>
              <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
                üïí ${livraison.heure} ${livraison.adresse ? `‚Ä¢ üìç ${livraison.adresse}` : ''}
              </p>
              ${livraison.effectuee === 'Non' && livraison.motifRefus ? 
                `<p style="margin: 5px 0 0 0; font-size: 12px; color: var(--error-color);">‚ùå ${livraison.motifRefus}</p>` : ''
              }
              ${livraison.commentaire ? 
                `<p style="margin: 5px 0 0 0; font-size: 12px; color: var(--text-tertiary);">üí¨ ${livraison.commentaire}</p>` : ''
              }
            </div>
            <button onclick="supprimerLivraison(${livraison.id})" style="background: var(--error-color); color: white; border: none; border-radius: 4px; padding: 5px 8px; font-size: 12px; cursor: pointer;">
              üóëÔ∏è
            </button>
          </div>
        </div>
      `).join('');
    }
    
    function updateLivraisonsProgress() {
      const total = phase2Data.livraisons.length;
      const livrees = phase2Data.livraisons.filter(l => l.effectuee === 'Oui').length;
      
      document.getElementById('livraisonProgress').textContent = `${livrees} / ${total} magasins livr√©s`;
      
      // Afficher le bouton terminer si au moins une livraison
      const btnTerminer = document.getElementById('btnTerminerLivraisons');
      if (btnTerminer) {
        btnTerminer.style.display = total > 0 ? 'block' : 'none';
      }
    }
    
    function supprimerLivraison(id) {
      if (confirm('üóëÔ∏è Supprimer cette livraison ?')) {
        phase2Data.livraisons = phase2Data.livraisons.filter(l => l.id !== id);
        localStorage.setItem('phase2_data', JSON.stringify(phase2Data));
        updateLivraisonsList();
        updateLivraisonsProgress();
      }
    }
    
    function loadExistingLivraisons() {
      updateLivraisonsList();
      updateLivraisonsProgress();
    }
    
    function terminerLivraisons() {
      if (phase2Data.livraisons.length === 0) {
        alert('‚ö†Ô∏è Aucune livraison enregistr√©e');
        return;
      }
      
      const total = phase2Data.livraisons.length;
      const livrees = phase2Data.livraisons.filter(l => l.effectuee === 'Oui').length;
      const nonLivrees = total - livrees;
      
      const message = `üì¶ R√©sum√© des Livraisons :
      
‚úÖ ${livrees} livraison(s) effectu√©e(s)
‚ùå ${nonLivrees} non-livraison(s)
üìä Total : ${total} magasin(s)

Continuer vers la fin de service ?`;
      
      if (confirm(message)) {
        // Marquer Phase 2 comme termin√©e
        localStorage.setItem('phase2_completed', 'true');
        phase2Data.completed = true;
        phase2Data.completedAt = new Date().toISOString();
        localStorage.setItem('phase2_data', JSON.stringify(phase2Data));
        
        // Upload des photos Phase 2
        uploadPhase2Photos();
        
        // Aller √† Phase 3
        showSection('phase3');
      }
    }
    
    // ============================================
    // ‚úÖ PHASE 3 - FIN DE SERVICE
    // ============================================
    
    let phase3Data = {
      photos: {}
    };
    
    function initPhase3() {
      console.log('‚úÖ Initialisation Phase 3');
      
      // üîù RETOUR HAUT DE PAGE PHASE 3
      window.scrollTo(0, 0);
      
      // Charger les donn√©es des phases pr√©c√©dentes
      loadPhase3Data();
      
      // Configurer les √©v√©nements
      setupPhase3Events();
      
      // Initialiser l'heure de retour
      initializeReturnTime();
    }
    
    function loadPhase3Data() {
      console.log('üìä Chargement donn√©es Phase 3');
      
      // R√©cup√©rer toutes les donn√©es des phases pr√©c√©dentes
      const sessionStorageData = JSON.parse(localStorage.getItem('sessionData') || '{}');
      const phase1StorageData = JSON.parse(localStorage.getItem('phase1_data') || '{}');
      const phase2StorageData = JSON.parse(localStorage.getItem('phase2_data') || '{}');
      
      // Remplir le r√©capitulatif
      if (sessionStorageData.conducteur) {
        document.getElementById('phase3Conducteur').textContent = 
          `${sessionStorageData.conducteur.prenom} ${sessionStorageData.conducteur.nom}`;
      }
      
      if (sessionStorageData.tournee) {
        document.getElementById('phase3Date').textContent = 
          new Date(sessionStorageData.tournee.date).toLocaleDateString('fr-FR');
      }
      
      if (phase1StorageData.heureDepart) {
        document.getElementById('phase3HeureDepart').textContent = phase1StorageData.heureDepart;
      }
      
      if (sessionStorageData.vehiculesSelected) {
        const vehicules = `${sessionStorageData.vehiculesSelected.tracteur} + ${sessionStorageData.vehiculesSelected.remorque}`;
        document.getElementById('phase3Vehicules').textContent = vehicules;
      }
      
      // Statistiques livraisons
      if (phase2StorageData.livraisons) {
        const total = phase2StorageData.livraisons.length;
        const livrees = phase2StorageData.livraisons.filter(l => l.effectuee === 'Oui').length;
        document.getElementById('phase3Livraisons').textContent = `${livrees}/${total} livr√©es`;
      }
      
      // Compter toutes les photos
      let totalPhotos = 0;
      if (phase1StorageData.photos) totalPhotos += Object.keys(phase1StorageData.photos).length;
      if (phase2StorageData.photos) totalPhotos += Object.keys(phase2StorageData.photos).length;
      document.getElementById('phase3Photos').textContent = totalPhotos;
      
      // Pr√©-remplir le kilom√©trage si disponible
      if (phase1StorageData.kilometrage) {
        const kmInitial = parseInt(phase1StorageData.kilometrage);
        // Estimer kilom√©trage final (+ 50-200 km selon livraisons)
        const estimatedKm = kmInitial + Math.min(200, 50 + (phase2StorageData.livraisons?.length || 0) * 15);
        document.getElementById('kilometrageFinal').placeholder = `Ex: ${estimatedKm}`;
      }
      
      // Charger les donn√©es Phase 3 existantes
      const phase3StorageData = JSON.parse(localStorage.getItem('phase3_data') || '{}');
      if (phase3StorageData.heureRetour) {
        phase3Data = phase3StorageData;
        // Restaurer les champs
        document.getElementById('heureRetour').value = phase3StorageData.heureRetour || '';
        document.getElementById('kilometrageFinal').value = phase3StorageData.kilometrageFinal || '';
        document.getElementById('commentairesFinaux').value = phase3StorageData.commentaires || '';
      }
    }
    
    function setupPhase3Events() {
      // Gestion des probl√®mes v√©hicule
      const radioProbleme = document.querySelector('input[name="etatVehicule"][value="D√©g√¢ts"]');
      const radioProblemetech = document.querySelector('input[name="etatVehicule"][value="Probl√®me"]');
      const radioBon = document.querySelector('input[name="etatVehicule"][value="Bon"]');
      const detailsDiv = document.getElementById('detailsProblemes');
      
      if (radioProbleme && radioProblemetech && radioBon && detailsDiv) {
        radioProbleme.addEventListener('change', () => {
          detailsDiv.style.display = 'block';
        });
        
        radioProblemetech.addEventListener('change', () => {
          detailsDiv.style.display = 'block';
        });
        
        radioBon.addEventListener('change', () => {
          detailsDiv.style.display = 'none';
        });
      }
      
      // Gestion des photos
      const photoInput = document.getElementById('photoFinService');
      if (photoInput) {
        // D√©tecter mobile
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
          console.log('üì± Mode mobile d√©tect√© - photos successives activ√©es');
          photoInput.addEventListener('change', handlePhase3PhotosMobile);
          
          // Afficher contr√¥les mobiles
          const mobileControls = document.querySelector('.mobile-photo-controls');
          if (mobileControls) {
            mobileControls.style.display = 'block';
          }
          
          // Cacher le label standard
          const standardLabel = document.querySelector('label[for="photoFinService"]');
          if (standardLabel) {
            standardLabel.style.display = 'none';
          }
        } else {
          console.log('üíª Mode desktop d√©tect√© - s√©lection multiple activ√©e');
          photoInput.addEventListener('change', handlePhase3Photos);
        }
      }
      
      // Sauvegarde automatique
      const inputs = document.querySelectorAll('#phase3 input, #phase3 textarea, #phase3 select');
      inputs.forEach(input => {
        input.addEventListener('change', savePhase3Data);
      });
    }
    
    function initializeReturnTime() {
      // Heure actuelle
      const now = new Date();
      const timeInput = document.getElementById('heureRetour');
      if (timeInput && !timeInput.value) {
        timeInput.value = now.toTimeString().slice(0, 5);
      }
    }
    
    function handlePhase3Photos(event) {
      const files = Array.from(event.target.files);
      const maxFiles = 3;
      
      if (files.length > maxFiles) {
        alert('‚ö†Ô∏è Maximum ' + maxFiles + ' photos autoris√©es');
        return;
      }
      
      const previewContainer = document.getElementById('previewFinService');
      previewContainer.innerHTML = '';
      
      files.forEach((file, index) => {
        if (file.size > 5 * 1024 * 1024) {
          alert('‚ö†Ô∏è Photo ' + file.name + ' trop volumineuse (max 5MB)');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const photoDiv = document.createElement('div');
          photoDiv.style.cssText = 'display: inline-block; margin: 5px; position: relative;';
          photoDiv.innerHTML = 
            '<img src="' + e.target.result + '" alt="Photo fin service ' + (index + 1) + '" style="max-width: 150px; border-radius: 8px; box-shadow: var(--shadow);">' +
            '<p style="font-size: 10px; text-align: center; margin: 5px 0; color: var(--text-secondary);">' +
              'üì∑ ' + file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)' +
            '</p>';
          previewContainer.appendChild(photoDiv);
          
          // Sauvegarder la photo avec structure correcte
          if (!phase3Data.photos) phase3Data.photos = {};
          const photoId = 'finService_' + index;
          phase3Data.photos[photoId] = {
            data: e.target.result,
            name: file.name || (photoId + '.jpg'),
            fileName: file.name || (photoId + '.jpg'),
            size: file.size || 0,
            fileSize: file.size || 0,
            timestamp: new Date().toISOString(),
            type: file.type || 'image/jpeg'
          };
          
          console.log('üì∑ Photo Phase 3 ' + photoId + ' sauvegard√©e:', {
            name: phase3Data.photos[photoId].name,
            fileName: phase3Data.photos[photoId].fileName,
            size: phase3Data.photos[photoId].size
          });
          
          savePhase3Data();
        };
        reader.readAsDataURL(file);
      });
    }
    
    // üì± FONCTION MOBILE: Photos successives Phase 3
    function handlePhase3PhotosMobile(event) {
      const files = Array.from(event.target.files);
      const maxFiles = 3;
      const existingPhotos = Object.keys(phase3Data.photos || {}).length;
      
      if (existingPhotos + files.length > maxFiles) {
        alert('‚ö†Ô∏è Maximum ' + maxFiles + ' photos au total. Vous en avez d√©j√† ' + existingPhotos);
        return;
      }
      
      const previewContainer = document.getElementById('previewFinService');
      files.forEach((file, index) => {
        if (file.size > 5 * 1024 * 1024) {
          alert('‚ö†Ô∏è Photo ' + file.name + ' trop volumineuse (max 5MB)');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const photoDiv = document.createElement('div');
          photoDiv.style.cssText = 'display: inline-block; margin: 5px; position: relative;';
          photoDiv.innerHTML = 
            '<img src="' + e.target.result + '" alt="Photo fin service ' + (existingPhotos + index + 1) + '" style="max-width: 150px; border-radius: 8px; box-shadow: var(--shadow);">' +
            '<p style="font-size: 10px; text-align: center; margin: 5px 0; color: var(--text-secondary);">' +
              'üì∑ ' + file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)' +
            '</p>' +
            '<button onclick="removePhase3Photo(this, \'' + 'finService_' + (existingPhotos + index) + '\')" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">√ó</button>';
          previewContainer.appendChild(photoDiv);
        };
        reader.readAsDataURL(file);
        
        // Sauvegarder pour upload ult√©rieur (index cumulatif)
        const photoId = 'finService_' + (existingPhotos + index);
        if (!phase3Data.photos) phase3Data.photos = {};
        phase3Data.photos[photoId] = {
          name: file.name || (photoId + '.jpg'),
          fileName: file.name || (photoId + '.jpg'),
          size: file.size || 0,
          fileSize: file.size || 0,
          type: file.type || 'image/jpeg',
          data: file
        };
        
        console.log('üì± Photo mobile Phase 3 ' + photoId + ' ajout√©e (' + (existingPhotos + index + 1) + '/' + maxFiles + ')');
      });
      
      // Mettre √† jour compteur
      const compteur = document.getElementById('photoCount');
      if (compteur) {
        const totalPhotos = Object.keys(phase3Data.photos || {}).length;
        compteur.textContent = totalPhotos + '/' + maxFiles;
      }
      
      // R√©initialiser input pour permettre une nouvelle s√©lection
      event.target.value = '';
      
      savePhase3Data();
    }
    
    // Fonction pour supprimer une photo Phase 3
    function removePhase3Photo(button, photoId) {
      // Supprimer de la data
      if (phase3Data.photos && phase3Data.photos[photoId]) {
        delete phase3Data.photos[photoId];
        console.log('üóëÔ∏è Photo ' + photoId + ' supprim√©e');
      }
      
      // Supprimer du DOM
      button.parentElement.remove();
      
      // Mettre √† jour compteur
      const compteur = document.getElementById('photoCount');
      if (compteur) {
        const totalPhotos = Object.keys(phase3Data.photos || {}).length;
        compteur.textContent = totalPhotos + '/3';
      }
      
      savePhase3Data();
    }
    
    function savePhase3Data() {
      console.log('üíæ Sauvegarde donn√©es Phase 3');
      
      phase3Data.heureRetour = document.getElementById('heureRetour').value;
      phase3Data.kilometrageFinal = document.getElementById('kilometrageFinal').value;
      phase3Data.etatVehicule = document.querySelector('input[name="etatVehicule"]:checked')?.value;
      phase3Data.descriptionProblemes = document.getElementById('descriptionProblemes').value.trim();
      phase3Data.nettoyage = document.querySelector('input[name="nettoyage"]:checked')?.value;
      phase3Data.commentaires = document.getElementById('commentairesFinaux').value.trim();
      phase3Data.timestamp = new Date().toISOString();
      
      // üöÄ NETTOYAGE LOCALSTORAGE pour √©viter QuotaExceeded
      try {
        localStorage.setItem('phase3_data', JSON.stringify(phase3Data));
      } catch (e) {
        console.warn('‚ö†Ô∏è localStorage plein - nettoyage Phase 3 sans photos');
        // Nettoyer les photos volumineuses des phases pr√©c√©dentes
        const cleanData = {...phase3Data};
        if (cleanData.photos) {
          Object.keys(cleanData.photos).forEach(photoId => {
            if (cleanData.photos[photoId].data) {
              delete cleanData.photos[photoId].data;
              cleanData.photos[photoId].storedOnServer = true;
            }
          });
        }
        try {
          localStorage.setItem('phase3_data', JSON.stringify(cleanData));
        } catch (e2) {
          console.error('‚ùå Impossible de sauvegarder phase3_data - nettoyage localStorage');
          // Nettoyage de secours
          localStorage.removeItem('phase1_data');
          localStorage.removeItem('phase2_data');
          localStorage.setItem('phase3_data', JSON.stringify(cleanData));
        }
      }
    }
    
    function terminerService() {
      console.log('üèÅ Finalisation du service');
      
      // Validation des champs obligatoires
      const heureRetour = document.getElementById('heureRetour').value;
      const kilometrageFinal = document.getElementById('kilometrageFinal').value;
      const confirmation = document.getElementById('confirmationComplete').checked;
      
      if (!heureRetour) {
        alert('‚ö†Ô∏è Veuillez saisir l\'heure de retour');
        return;
      }
      
      if (!kilometrageFinal) {
        alert('‚ö†Ô∏è Veuillez saisir le kilom√©trage final');
        return;
      }
      
      if (!confirmation) {
        alert('‚ö†Ô∏è Veuillez confirmer que tous les contr√¥les ont √©t√© effectu√©s');
        return;
      }
      
      // Sauvegarder les donn√©es finales
      savePhase3Data();
      
      // Sauvegarder sur Google Sheets
      savePhase3ToBackend(phase3Data);
      
      // Upload des photos Phase 3
      uploadPhase3Photos();
      
      // Calculer les statistiques finales
      const sessionStorageData = JSON.parse(localStorage.getItem('sessionData') || '{}');
      const phase1StorageData = JSON.parse(localStorage.getItem('phase1_data') || '{}');
      const phase2StorageData = JSON.parse(localStorage.getItem('phase2_data') || '{}');
      
      const kmParcourus = parseInt(kilometrageFinal) - parseInt(phase1StorageData.kilometrage || 0);
      const totalLivraisons = phase2StorageData.livraisons?.length || 0;
      const livraisonsReussies = phase2StorageData.livraisons?.filter(l => l.effectuee === 'Oui').length || 0;
      
      let totalPhotos = 0;
      if (phase1StorageData.photos) totalPhotos += Object.keys(phase1StorageData.photos).length;
      if (phase2StorageData.photos) totalPhotos += Object.keys(phase2StorageData.photos).length;
      if (phase3Data.photos) totalPhotos += Object.keys(phase3Data.photos).length;
      
      // Message de confirmation final
      const message = `üéâ Service Termin√© avec Succ√®s !
      
üìä R√©sum√© de la Tourn√©e :
‚Ä¢ Conducteur : ${sessionStorageData.conducteur?.prenom} ${sessionStorageData.conducteur?.nom}
‚Ä¢ Dur√©e : ${phase1StorageData.heureDepart} ‚Üí ${heureRetour}
‚Ä¢ Distance : ${kmParcourus} km parcourus
‚Ä¢ Livraisons : ${livraisonsReussies}/${totalLivraisons} r√©ussies
‚Ä¢ Photos : ${totalPhotos} prises
‚Ä¢ √âtat v√©hicule : ${phase3Data.etatVehicule}

‚úÖ Toutes les donn√©es ont √©t√© sauvegard√©es.
üì§ Les donn√©es seront synchronis√©es avec le serveur.

Merci pour votre travail !`;
      
      alert(message);
      
      // Marquer comme termin√©
      localStorage.setItem('phase3_completed', 'true');
      phase3Data.completed = true;
      phase3Data.completedAt = new Date().toISOString();
      localStorage.setItem('phase3_data', JSON.stringify(phase3Data));
      
      // Marquer la session comme compl√®te
      localStorage.setItem('session_completed', 'true');
      
      // Proposer de commencer une nouvelle tourn√©e
      setTimeout(() => {
        if (confirm('üöÄ Voulez-vous commencer une nouvelle tourn√©e ?')) {
          // Nettoyer les donn√©es et recommencer
          clearAllData();
          showSection('home');
        } else {
          // Retourner √† l'accueil
          showSection('home');
        }
      }, 2000);
    }
    
    function loadRecentSessions() {
      console.log('üîÑ Chargement sessions r√©centes');
      // √Ä d√©velopper...
    }
    
    function loadSessionHistory() {
      console.log('üìä Chargement historique');
      // √Ä d√©velopper...
    }
    
    // ============================================
    // üîß UTILITAIRES
    // ============================================
    
    function generateSessionId() {
      const timestamp = Date.now();
      const random = Math.random().toString(36).substr(2, 9);
      return 'PS_' + timestamp + '_' + random;
    }
    
    // Fonction pour nettoyer toutes les donn√©es de session
    function clearAllData() {
      console.log('üßπ Nettoyage complet des donn√©es...');
      
      // Supprimer du localStorage
      localStorage.removeItem('sessionData');
      localStorage.removeItem('phase0_data');
      localStorage.removeItem('phase1_data');
      localStorage.removeItem('phase2_data');
      localStorage.removeItem('phase3_data');
      localStorage.removeItem('currentSessionId');
      localStorage.removeItem('offline_queue');
      
      // R√©initialiser les variables globales
      sessionData = {};
      appState = {
        isConnected: false,
        conducteur: null,
        phase: 'home'
      };
      phase1Data = { photos: {} };
      phase2Data = { livraisons: [], photos: {} };
      phase3Data = { photos: {} };
      
      console.log('‚úÖ Donn√©es nettoy√©es');
    }
    
    function updateConnectionStatus() {
      const indicator = document.getElementById('connectionStatus');
      if (navigator.onLine) {
        indicator.className = 'status-indicator status-online';
        indicator.textContent = 'En ligne';
      } else {
        indicator.className = 'status-indicator status-offline';
        indicator.textContent = 'Hors ligne';
      }
    }
    
    // ============================================
    // üöÄ INITIALISATION SPA
    // ============================================
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ SPA Mobile initialis√©e');
      
      // V√©rifier statut connexion
      updateConnectionStatus();
      
      // √âcouter les changements de connexion
      window.addEventListener('online', updateConnectionStatus);
      window.addEventListener('offline', updateConnectionStatus);
      
      // Charger session sauvegard√©e si elle existe
      const savedSessionId = localStorage.getItem('currentSessionId');
      if (savedSessionId) {
        console.log('üì± Session sauvegard√©e trouv√©e:', savedSessionId);
        // Option de reprendre automatiquement ou demander
      }
      
      // Initialiser les gestionnaires d'√©v√©nements Phase 1
      setupPhase1PhotoUpload();
      
      console.log('‚úÖ SPA pr√™te pour utilisation mobile');
    });
    
    // ============================================
    // ‚úÖ FIN DE CHARGEMENT JAVASCRIPT
    // ============================================
    
    // Fonctions pour afficher/masquer les d√©tails des d√©g√¢ts
    function showDegatsTracteurDetails() {
      document.getElementById('degatsTracteurDetails').style.display = 'block';
    }
    
    function hideDegatsTracteurDetails() {
      document.getElementById('degatsTracteurDetails').style.display = 'none';
      document.getElementById('detailsDegatsTracteur').value = '';
    }
    
    function showDegatsRemorqueDetails() {
      document.getElementById('degatsRemorqueDetails').style.display = 'block';
    }
    
    function hideDegatsRemorqueDetails() {
      document.getElementById('degatsRemorqueDetails').style.display = 'none';
      document.getElementById('detailsDegatsRemorque').value = '';
    }
    
    // Rendre ces fonctions globales
    window.showDegatsTracteurDetails = showDegatsTracteurDetails;
    window.hideDegatsTracteurDetails = hideDegatsTracteurDetails;
    window.showDegatsRemorqueDetails = showDegatsRemorqueDetails;
    window.hideDegatsRemorqueDetails = hideDegatsRemorqueDetails;
    
    console.log('‚úÖ JavaScript enti√®rement charg√© !');
    console.log('üîß Fonctions disponibles:', {
      showSection: typeof showSection,
      startNewTour: typeof startNewTour,
      connectConducteur: typeof connectConducteur
    });
    
    // Test final des fonctions
    if (typeof showSection === 'function') {
      console.log('‚úÖ showSection OK');
    } else {
      console.error('‚ùå showSection manquante');
    }
    
    if (typeof startNewTour === 'function') {
      console.log('‚úÖ startNewTour OK');  
    } else {
      console.error('‚ùå startNewTour manquante');
    }
    
  </script>
  
</body>
</html>
