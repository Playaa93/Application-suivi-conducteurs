<script>
// Variables globales
let currentStep = 1;
let totalSteps = 12; // âœ… CHANGÃ‰ de 6 Ã  12
let formData = {};
let photos = {};
let pendingSync = 0;

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸš€ App initialisÃ©e');
  updateConnectionStatus();
  updateProgressBar();
  initializeEventListeners();
  checkPendingData();
});

// Navigation
function nextStep() {
  console.log(`ğŸš€ Tentative passage Ã  l'Ã©tape suivante depuis ${currentStep}`);
  
  if (validateCurrentStep()) {
    console.log(`âœ… Validation rÃ©ussie pour Ã©tape ${currentStep}`);
    saveCurrentStepData();
    
    if (currentStep < totalSteps) {
      const currentStepEl = document.getElementById(`step${currentStep}`);
      const nextStepEl = document.getElementById(`step${currentStep + 1}`);
      
      console.log(`ğŸ”„ Transition: Ã©tape ${currentStep} â†’ ${currentStep + 1}`);
      console.log(`Current step element:`, currentStepEl ? 'TROUVÃ‰' : 'MANQUANT');
      console.log(`Next step element:`, nextStepEl ? 'TROUVÃ‰' : 'MANQUANT');
      
      if (currentStepEl) currentStepEl.classList.remove('active');
      currentStep++;
      if (nextStepEl) nextStepEl.classList.add('active');
      
      updateProgressBar();
      window.scrollTo(0, 0);
      
      console.log(`âœ… Navigation terminÃ©e, Ã©tape actuelle: ${currentStep}`);
    } else {
      console.log(`ğŸ DerniÃ¨re Ã©tape atteinte (${currentStep}/${totalSteps})`);
    }
  } else {
    console.log(`âŒ Validation Ã©chouÃ©e pour Ã©tape ${currentStep}`);
  }
}

function prevStep() {
  if (currentStep > 1) {
    document.getElementById(`step${currentStep}`).classList.remove('active');
    currentStep--;
    document.getElementById(`step${currentStep}`).classList.add('active');
    updateProgressBar();
    window.scrollTo(0, 0);
  }
}

function updateProgressBar() {
  const progressFill = document.querySelector('.progress-fill');
  const progressBar = document.querySelector('.progress-bar');
  const percentage = (currentStep / totalSteps) * 100;
  
  console.log(`ğŸ”„ Mise Ã  jour barre de progression: Ã©tape ${currentStep}/${totalSteps} = ${percentage.toFixed(1)}%`);
  
  if (progressFill) {
    progressFill.style.width = percentage + '%';
  }
  
  if (progressBar) {
    progressBar.setAttribute('aria-valuenow', percentage.toFixed(0));
  }
}

// Validation
function validateCurrentStep() {
  console.log(`ğŸ” Validation de l'Ã©tape ${currentStep}`);
  const currentStepEl = document.getElementById(`step${currentStep}`);
  
  if (!currentStepEl) {
    console.error(`âŒ Ã‰lÃ©ment step${currentStep} introuvable`);
    return false;
  }
  
  const requiredInputs = currentStepEl.querySelectorAll('[required]');
  console.log(`ğŸ” ${requiredInputs.length} champs obligatoires trouvÃ©s`);
  
  for (let input of requiredInputs) {
    const value = input.value ? input.value.trim() : '';
    console.log(`ğŸ” Validation ${input.id || input.name}: "${value}"`);
    
    if (!value) {
      const label = input.closest('.input-group')?.querySelector('label')?.textContent || 'Champ inconnu';
      console.log(`âŒ Champ vide: ${label}`);
      alert(`Le champ "${label}" est obligatoire`);
      input.focus();
      return false;
    }
  }
  
  console.log(`âœ… Tous les champs obligatoires sont remplis`);
  
  // Validation des radio buttons obligatoires
  const radioGroups = currentStepEl.querySelectorAll('input[type="radio"][required]');
  const radioGroupNames = [...new Set([...radioGroups].map(r => r.name))];
  
  for (let groupName of radioGroupNames) {
    const checkedRadio = currentStepEl.querySelector(`input[name="${groupName}"]:checked`);
    if (!checkedRadio) {
      console.log(`âŒ Groupe radio non sÃ©lectionnÃ©: ${groupName}`);
      alert(`Veuillez sÃ©lectionner une option pour "${groupName}"`);
      return false;
    }
  }
  
  // âœ… CORRECTION : Validations photos par Ã©tape avec debug
  switch(currentStep) {
    case 2: // Tracteur
      console.log('ğŸ” Validation Ã©tape 2, photos:', Object.keys(photos));
      if (!photos.carburant) {
        alert('La photo de la jauge carburant est obligatoire');
        return false;
      }
      break;
      
    case 3: // Photos tracteur  
      console.log('ğŸ” Validation Ã©tape 3, photos:', Object.keys(photos));
      if (!photos.faceAvant || !photos.coteConducteur || !photos.cotePassager) {
        const manquantes = [];
        if (!photos.faceAvant) manquantes.push('face avant');
        if (!photos.coteConducteur) manquantes.push('cÃ´tÃ© conducteur');
        if (!photos.cotePassager) manquantes.push('cÃ´tÃ© passager');
        alert(`Photos manquantes: ${manquantes.join(', ')}`);
        return false;
      }
      break;
      
    case 6: // Chargement
      console.log('ğŸ” Validation Ã©tape 6, photos:', Object.keys(photos));
      if (!photos.chargement || !photos.remorquePortes) {
        alert('Les photos du chargement et des portes sont obligatoires');
        return false;
      }
      break;

      // âœ… AJOUTER ces validations aprÃ¨s le case 6
case 8: // Magasin 1
  if (!photos.magasin1Photo) {
    alert('La photo du magasin 1 est obligatoire');
    return false;
  }
  break;
  
case 9: // Magasin 2  
  if (!photos.magasin2Photo) {
    alert('La photo du magasin 2 est obligatoire');
    return false;
  }
  break;
  
case 10: // Magasin 3
  if (!photos.magasin3Photo) {
    alert('La photo du magasin 3 est obligatoire');
    return false;
  }
  break;
  
case 12: // Fin de service
  if (!photos.pdaReprises || !photos.caisseVides || !photos.lettreVoiture || !photos.caisseNettoyee || !photos.carburantFin) {
    alert('Toutes les photos de fin de service sont obligatoires');
    return false;
  }
  break;
  }
  
  return true;
}

function saveCurrentStepData() {
  const currentStepEl = document.getElementById(`step${currentStep}`);
  const inputs = currentStepEl.querySelectorAll('input, select, textarea');
  
  inputs.forEach(input => {
    if (input.type === 'radio') {
      if (input.checked) {
        formData[input.name] = input.value;
      }
    } else if (input.type === 'checkbox') {
      if (!formData[input.name]) formData[input.name] = [];
      if (input.checked && !formData[input.name].includes(input.value)) {
        formData[input.name].push(input.value);
      }
    } else if (input.id) {
      formData[input.id] = input.value;
    }
  });
}

// âœ… CORRECTION : Gestion photos amÃ©liorÃ©e
function takePhoto(photoType) {
  console.log('ğŸ“¸ Tentative prise de photo:', photoType);
  
  // âœ… Construction correcte de l'ID
  const inputId = `photo${photoType.charAt(0).toUpperCase() + photoType.slice(1)}`;
  const input = document.getElementById(inputId);
  
  console.log('ğŸ” Recherche input:', inputId, input ? 'TROUVÃ‰' : 'INTROUVABLE');
  
  if (input) {
    input.click();
    console.log('âœ… Click dÃ©clenchÃ© sur input');
  } else {
    console.error('âŒ Input non trouvÃ©:', inputId);
    alert(`Erreur: Input ${inputId} non trouvÃ©`);
  }
}

function initializeEventListeners() {
  // âœ… CORRECTION : Photos avec debug dÃ©taillÃ©
  const photoInputs = document.querySelectorAll('input[type="file"]');
  console.log('ğŸ” Inputs photo trouvÃ©s:', photoInputs.length);
  
  photoInputs.forEach((input, index) => {
    console.log(`ğŸ” Input ${index}:`, input.id);
    
    input.addEventListener('change', function(e) {
      const file = e.target.files[0];
      console.log('ğŸ“¸ Fichier sÃ©lectionnÃ©:', file ? file.name : 'AUCUN');
      
      if (file) {
        // âœ… CORRECTION : Extraction correcte du type de photo
        const photoType = extractPhotoType(this.id);
        console.log('ğŸ¯ Type photo extrait:', photoType);
        processPhoto(file, photoType);
      }
    });
  });
  
  // Radio buttons
  const radioInputs = document.querySelectorAll('input[type="radio"]');
  radioInputs.forEach(input => {
    input.addEventListener('change', function() {
      updateRadioDisplay(this.name);
    });
  });
  
  // Checkboxes
  const checkboxInputs = document.querySelectorAll('input[type="checkbox"]');
  checkboxInputs.forEach(input => {
    input.addEventListener('change', function() {
      updateCheckboxDisplay(this);
    });
  });
}

// âœ… NOUVELLE FONCTION : Extraction propre du type de photo
function extractPhotoType(inputId) {
  // Mapping direct pour Ã©viter les erreurs de casse
  const photoMapping = {
    'photoCarburant': 'carburant',
    'photoFaceAvant': 'faceAvant',
    'photoCoteConducteur': 'coteConducteur',
    'photoCotePassager': 'cotePassager',
    'photoCarburantRemorque': 'carburantRemorque',
    'photoHayon': 'hayon',
    'photoRemorqueTablier': 'remorqueTablier',
    'photoRemorqueConducteur': 'remorqueConducteur',
    'photoRemorquePassager': 'remorquePassager',
    'photoChargement': 'chargement',
    'photoRemorquePortes': 'remorquePortes'
  };
  
  return photoMapping[inputId] || inputId.replace('photo', '');
}

function processPhoto(file, photoType) {
  console.log('ğŸ”„ Traitement photo:', photoType, file.name, `${(file.size/1024/1024).toFixed(2)}MB`);
  
  if (file.size > 10 * 1024 * 1024) {
    alert('La photo est trop voluminieuse (max 10MB)');
    return;
  }
  
  compressImage(file, (compressedFile) => {
    console.log('âœ… Compression terminÃ©e:', `${(compressedFile.size/1024/1024).toFixed(2)}MB`);
    
    // âœ… CORRECTION : Preview avec ID exact
    const previewId = `preview${photoType.charAt(0).toUpperCase() + photoType.slice(1)}`;
    const preview = document.getElementById(previewId);
    
    console.log('ğŸ” Recherche preview:', previewId, preview ? 'TROUVÃ‰' : 'INTROUVABLE');
    
    if (preview) {
      preview.src = URL.createObjectURL(compressedFile);
      preview.style.display = 'block';
      console.log('âœ… Preview affichÃ©');
    }
    
    // âœ… CORRECTION : Interface update avec sÃ©lecteur plus robuste
    const photoInput = document.querySelector(`[onclick*="${photoType}"]`);
    console.log('ğŸ” Photo input container:', photoInput ? 'TROUVÃ‰' : 'INTROUVABLE');
    
    if (photoInput) {
      photoInput.classList.add('has-photo');
      const textElement = photoInput.querySelector('.photo-text');
      if (textElement) {
        textElement.textContent = 'âœ… Photo capturÃ©e';
        console.log('âœ… Texte mis Ã  jour');
      }
    }
    
    // âœ… Stocker la photo
    const reader = new FileReader();
    reader.onload = function(e) {
      photos[photoType] = {
        data: e.target.result.split(',')[1],
        type: compressedFile.type,
        name: `${photoType}_${Date.now()}.jpg`,
        size: compressedFile.size
      };
      
      console.log('ğŸ’¾ Photo stockÃ©e:', photoType);
      console.log('ğŸ“Š Photos actuelles:', Object.keys(photos));
    };
    reader.readAsDataURL(compressedFile);
  });
}

function compressImage(file, callback) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  
  img.onload = function() {
    const maxSize = 1200;
    let { width, height } = img;
    
    if (width > height && width > maxSize) {
      height = (height * maxSize) / width;
      width = maxSize;
    } else if (height > maxSize) {
      width = (width * maxSize) / height;
      height = maxSize;
    }
    
    canvas.width = width;
    canvas.height = height;
    ctx.drawImage(img, 0, 0, width, height);
    canvas.toBlob(callback, 'image/jpeg', 0.8);
  };
  
  img.src = URL.createObjectURL(file);
}

function updateRadioDisplay(name) {
  const radios = document.querySelectorAll(`input[name="${name}"]`);
  radios.forEach(radio => {
    const container = radio.closest('.radio-item');
    if (container) {
      if (radio.checked) {
        container.classList.add('selected');
      } else {
        container.classList.remove('selected');
      }
    }
  });
}

function updateCheckboxDisplay(checkbox) {
  const container = checkbox.closest('.checkbox-item');
  if (container) {
    if (checkbox.checked) {
      container.classList.add('selected');
    } else {
      container.classList.remove('selected');
    }
  }
}

// Connexion
function updateConnectionStatus() {
  const indicator = document.getElementById('connectionStatus');
  if (navigator.onLine) {
    indicator.innerHTML = 'ğŸŸ¢ En ligne';
    indicator.className = 'offline-indicator online';
    if (pendingSync > 0) syncOfflineData();
  } else {
    indicator.innerHTML = 'ğŸ”´ Hors ligne';
    indicator.className = 'offline-indicator offline';
  }
}

function checkPendingData() {
  const offlineData = JSON.parse(localStorage.getItem('offlineData') || '[]');
  pendingSync = offlineData.length;
  if (pendingSync > 0) {
    const indicator = document.getElementById('pendingIndicator');
    if (indicator) {
      indicator.innerHTML = `ğŸ“¤ ${pendingSync} formulaire(s) en attente`;
      indicator.style.display = 'block';
    }
  }
}

// Events connexion
window.addEventListener('online', updateConnectionStatus);
window.addEventListener('offline', updateConnectionStatus);

// Soumission
function submitForm() {
  console.log('ğŸ“ Soumission formulaire...');
  console.log('ğŸ“Š Photos disponibles:', Object.keys(photos));
  
  if (!validateCurrentStep()) return;
  
  saveCurrentStepData();
  formData.timestamp = new Date().toISOString();
  formData.photos = photos;
  formData.photosCount = Object.keys(photos).length;
  
  console.log('ğŸ“‹ DonnÃ©es finales:', {
    fieldsCount: Object.keys(formData).length,
    photosCount: formData.photosCount
  });
  
  const submitBtn = document.querySelector('.btn-success');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="loading"></span> Envoi en cours...';
  
  if (navigator.onLine) {
    saveToServer();
  } else {
    saveOffline();
  }
}

function saveToServer() {
  console.log('â˜ï¸ Sauvegarde serveur...');
  google.script.run
    .withSuccessHandler(onSaveSuccess)
    .withFailureHandler(onSaveError)
    .saveFormData(formData);
}

function saveOffline() {
  console.log('ğŸ’¾ Sauvegarde hors ligne...');
  try {
    let offlineData = JSON.parse(localStorage.getItem('offlineData') || '[]');
    offlineData.push(formData);
    localStorage.setItem('offlineData', JSON.stringify(offlineData));
    pendingSync++;
    showSuccessMessage('âœ… SauvegardÃ© hors ligne', 'Sera synchronisÃ© Ã  la reconnexion');
  } catch (error) {
    console.error('âŒ Erreur sauvegarde offline:', error);
    alert('Erreur sauvegarde hors ligne: ' + error.message);
  }
}

function syncOfflineData() {
  const offlineData = JSON.parse(localStorage.getItem('offlineData') || '[]');
  if (offlineData.length > 0 && navigator.onLine) {
    console.log(`ğŸ”„ Synchronisation ${offlineData.length} formulaire(s)...`);
    google.script.run
      .withSuccessHandler(() => {
        console.log('âœ… Synchronisation rÃ©ussie');
        localStorage.removeItem('offlineData');
        pendingSync = 0;
        const indicator = document.getElementById('pendingIndicator');
        if (indicator) indicator.style.display = 'none';
      })
      .withFailureHandler((error) => {
        console.error('âŒ Erreur synchronisation:', error);
      })
      .syncOfflineData(offlineData);
  }
}

function onSaveSuccess(result) {
  console.log('âœ… Sauvegarde rÃ©ussie:', result);
  showSuccessMessage('ğŸ‰ Formulaire envoyÃ© !', 'Prise de service enregistrÃ©e avec succÃ¨s');
}

function onSaveError(error) {
  console.error('âŒ Erreur serveur:', error);
  saveOffline();
}

function showSuccessMessage(title, details) {
  document.querySelectorAll('.step').forEach(step => step.style.display = 'none');
  const container = document.querySelector('.form-container');
  container.innerHTML = `
    <div class="success-message">
      <div class="success-icon">ğŸ‰</div>
      <h2 class="success-title">${title}</h2>
      <p class="success-details">${details}</p>
      <button class="btn btn-primary" onclick="location.reload()">ğŸ“ Nouveau formulaire</button>
    </div>
  `;
}

// âœ… NOUVELLE FONCTION : Debug photos
function debugPhotos() {
  console.log('ğŸ” DEBUG PHOTOS:');
  console.log('ğŸ“Š Photos stockÃ©es:', Object.keys(photos));
  console.log('ğŸ“‹ DÃ©tail photos:', photos);
  
  // VÃ©rifier les inputs
  const inputs = document.querySelectorAll('input[type="file"]');
  console.log('ğŸ” Inputs trouvÃ©s:', Array.from(inputs).map(i => i.id));
  
  // VÃ©rifier les previews
  const previews = document.querySelectorAll('img[id^="preview"]');
  console.log('ğŸ” Previews trouvÃ©s:', Array.from(previews).map(i => i.id));
}

// Pour debug, accessible depuis la console
window.debugPhotos = debugPhotos;

// âœ… FONCTION DEBUG GÃ‰NÃ‰RALE
function debugApp() {
  console.log('ğŸ” === DEBUG APPLICATION ===');
  console.log(`ğŸ“ Ã‰tape actuelle: ${currentStep}/${totalSteps}`);
  console.log(`ğŸ“Š Photos stockÃ©es:`, Object.keys(photos));
  console.log(`ğŸ“‹ DonnÃ©es formulaire:`, Object.keys(formData));
  
  // VÃ©rifier tous les steps
  for (let i = 1; i <= totalSteps; i++) {
    const stepEl = document.getElementById(`step${i}`);
    const isActive = stepEl?.classList.contains('active');
    const isVisible = stepEl ? window.getComputedStyle(stepEl).display !== 'none' : false;
    console.log(`ğŸ“„ Step ${i}: ${stepEl ? 'EXISTE' : 'MANQUE'}, active: ${isActive}, visible: ${isVisible}`);
  }
  
  // VÃ©rifier la barre de progression
  const progressFill = document.querySelector('.progress-fill');
  const progressWidth = progressFill ? progressFill.style.width : 'N/A';
  console.log(`ğŸ“Š Barre de progression: ${progressWidth}`);
  
  return {
    currentStep,
    totalSteps,
    photos: Object.keys(photos),
    formData: Object.keys(formData),
    progressWidth
  };
}

// âœ… FONCTION POUR FORCER LE PASSAGE Ã€ L'Ã‰TAPE SUIVANTE (debug)
function forceNextStep() {
  console.log('ğŸš¨ FORCE: Passage Ã  l\'Ã©tape suivante sans validation');
  
  if (currentStep < totalSteps) {
    const currentStepEl = document.getElementById(`step${currentStep}`);
    const nextStepEl = document.getElementById(`step${currentStep + 1}`);
    
    if (currentStepEl) currentStepEl.classList.remove('active');
    currentStep++;
    if (nextStepEl) nextStepEl.classList.add('active');
    
    updateProgressBar();
    window.scrollTo(0, 0);
    
    console.log(`âœ… FORCE: Passage rÃ©ussi Ã  l'Ã©tape ${currentStep}`);
  } else {
    console.log('ğŸ FORCE: DÃ©jÃ  Ã  la derniÃ¨re Ã©tape');
  }
}

// Accessibles depuis la console pour debug
window.debugApp = debugApp;
window.forceNextStep = forceNextStep;
</script>